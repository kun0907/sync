<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="Stock">
    <resultMap id="stockMap" type="Stock">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu Mar 16 15:40:49 CST 2017.
        -->
        <id column="stock_id" property="stockId" jdbcType="VARCHAR"/>
        <result column="stock_num" property="stockNum" jdbcType="DECIMAL"/>
        <result column="lock_num" property="lockNum" jdbcType="DECIMAL"/>
        <result column="stock_state" property="stockState" jdbcType="VARCHAR"/>
        <result column="old_stock_id" property="oldStockId" jdbcType="VARCHAR"/>
        <association property="materials" column="materials" select="Materials.selectByPk"/>
        <association property="wbs" column="wbs" select="Project.selectByPk"/>
        <association property="warehouse" column="warehouse" select="WareHouse.selectByPk"/>
        <association property="reservoirarea" column="reservoirarea" select="Reservoirarea.selectByPk"/>
        <association property="storagelocation" column="storagelocation" select="Storagelocation.selectByPk"/>
    </resultMap>

    <!-- 分页查询承包商信息  -->
    <select id="selectByCondition" resultMap="stockMap" parameterType="map">
        select * from (
        select rs.*,
        ROW_NUMBER() OVER(order by rs.stock_id) r
        from r_stock rs
        left join b_project bp on rs.wbs = bp.project_id
        left join b_storagelocation bs on rs.storagelocation = bs.storagelocation_id
        <where>
            <if test="StockCondition.wbsCode!=null and StockCondition.wbsCode!=''">and bp.project_code like '%' ||
                #{StockCondition.wbsCode} || '%'
            </if>
            <if test="StockCondition.stockState!=null and StockCondition.stockState!=''">and rs.stock_state =
                #{StockCondition.stockState}
            </if>
            <if test="StockCondition.storagelocationCode!=null and StockCondition.storagelocationCode!=''">and
                bs.storagelocation_code = #{StockCondition.storagelocationCode}
            </if>
        </where>
        ) s where s.r between #{page.startPos} and ((#{page.pageSize}+#{page.startPos})-1)

    </select>
    <!-- 分页查询承包商数量 -->
    <select id="countByCondition" resultType="int" parameterType="map">
        select count(*)
        from r_stock rs
        left join b_project bp on rs.wbs = bp.project_id
        left join b_storagelocation bs on rs.storagelocation = bs.storagelocation_id
        <where>
            <if test="StockCondition.wbsCode!=null and StockCondition.wbsCode!=''">and bp.project_code like '%' ||
                #{StockCondition.wbsCode} || '%'
            </if>
            <if test="StockCondition.stockState!=null and StockCondition.stockState!=''">and rs.stock_state =
                #{StockCondition.stockState}
            </if>
            <if test="StockCondition.storagelocationCode!=null and StockCondition.storagelocationCode!=''">and
                bs.storagelocation_code = #{StockCondition.storagelocationCode}
            </if>
        </where>
    </select>
    <select id="selectCountByCondition" resultType="int">
        select count(*) from r_stock rs
        <where>
            rs.wbs = #{wbs.projectId} and rs.materials = #{materials.materialsId} and rs.storagelocation =
            #{storagelocation.storagelocationId}
        </where>
    </select>

    <!-- 插入库存信息 -->
    <insert id="insert" useGeneratedKeys="false">
    insert into r_stock (
    stock_id,materials,wbs,stock_num,lock_num,stock_state,warehouse,reservoirarea,storagelocation,old_stock_id
    ) values (
    #{stockId},#{materials.materialsId},#{wbs.projectId},#{stockNum},0,#{stockState},#{warehouse.warehouseId},
    #{reservoirarea.reservoirareaId},#{storagelocation.storagelocationId},#{oldStockId}
    )
  </insert>
    <!-- 更新库存明细信息 -->
    <update id="update">
        update r_stock rs
        <set>
            rs.stock_num = #{stockNum}
            <if test="lockNum!=null">,rs.lock_num = #{lockNum}</if>
        </set>
        <where>
            rs.wbs = #{wbs.projectId} and rs.materials = #{materials.materialsId} and rs.storagelocation =
            #{storagelocation.storagelocationId}
        </where>
    </update>
    <!-- 根据库存id查询库存信息 -->
    <select id="selectByPk" parameterType="string">
      select * from r_stock rs
      <where>
          rs.stock_id = #{stockId}
      </where>
    </select>

    <!-- 根据物料WBS储位查询库存信息 -->
    <select id="queryStockByMaterialAndWbs" resultMap="stockMap">
        select * from r_stock rs
        <where>
            rs.wbs = #{wbs.projectId} and rs.materials = #{materials.materialsId} and rs.storagelocation = #{storagelocation.storagelocationId}
        </where>
    </select>


    <!-- 根据物料WBS储位查询库存合计数量信息 -->
    <select id="queryStockSumNum" resultMap="stockMap">
       select nvl(nvl(s.stock_num,0)-nvl(notice.num,0),0) stock_num,s.materials,s.wbs from
    (
       select sum(stock_num-lock_num) as stock_num,rs.wbs,rs.materials from r_stock rs
            group by rs.wbs,rs.materials
    )s left join (
      select sum(nd.pick_num-nd.tallyed_nu  )as num, nd.materials,nd.wbs
            from OUT_PICK_NOTICE_DETAIL nd left join out_pick_notice n
            on nd.pick_notice=n.pick_id
            where n.pick_notice_state='pickNoticeCommit'
            group by nd.materials,nd.wbs
    ) notice on s.materials = notice.materials and s.wbs = notice.wbs

    </select>
</mapper>