<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Role">
	<resultMap type="Role" id="roleMap">
		<id column="role_id" property="roleId"/>
		<result column="role_name" property="roleName"/>
		<result column="role_code" property="roleCode"/>
		<result column="is_del" property="isDel"/>
		<result column="role_type" property="roleType"/>
		 <collection property="resources" ofType="Resource" column="role_id">
	       	<id column="resource_id" property="resourceId"/>
			<result column="resource_code" property="resourceCode"/>
			<result column="resource_name" property="resourceName"/>
			<result column="resource_type" property="resourceType"/>
			<result column="resource_url" property="url"/>
			<result column="parent_id" property="parentId"/>
	    </collection>
	</resultMap>
	<sql id="all">sr.*</sql>
	<!-- 分页查询角色信息  -->
	<select id="selectByCondition" resultType="java.util.HashMap" parameterType="Map">
		select * from(
			select <include refid="all"/>,ROW_number()OVER(order by sr.role_code desc) r from sys_role sr
			<where>
				sr.is_del !=1
					<if test="RoleCondition.orgId!=null and RoleCondition.orgId!=''"> and sr.root_org_id = #{RoleCondition.orgId} </if>		
					<if test="RoleCondition.roleName!=null and RoleCondition.roleName!=''"> and sr.role_name like '%' || #{RoleCondition.roleName}  || '%'</if>		
					<if test="RoleCondition.roleCode!=null and RoleCondition.roleCode!=''"> and sr.role_code like '%' || #{RoleCondition.roleCode} || '%'</if>		
			</where>
		)s where s.r between #{page.startPos} and ((#{page.pageSize}+#{page.startPos})-1) 
	</select>
	<!-- 分页角色数量 -->
	<select id="countByCondition" resultType="int" parameterType="map">
		select count(*)from sys_role sr 
		<where>
			sr.is_del !=1
			<if test="RoleCondition.orgId!=null and RoleCondition.orgId!=''"> and sr.root_org_id = #{RoleCondition.orgId} </if>		
			<if test="RoleCondition.roleName!=null and RoleCondition.roleName!=''"> and sr.role_name like '%' || #{RoleCondition.roleName}  || '%'</if>		
			<if test="RoleCondition.roleCode!=null and RoleCondition.roleCode!=''"> and sr.role_code like '%' || #{RoleCondition.roleCode} || '%'</if>		
		</where>
	</select>
	<!-- 插入角色信息 -->
	<insert id="insert" useGeneratedKeys="false">
		insert into sys_role(
			role_id,role_code,role_name,is_del,root_org_id,role_type
		)
		values(
			#{roleId},#{roleCode},#{roleName},#{isDel},#{rootOrgId},#{roleType}
		)
	</insert>
	<!-- 更新角色信息 -->
	<update id="update">
		update sys_role
		<set>
			<if test="roleName!=null and roleName !=''">role_name=#{roleName}</if>
		</set>
		where role_id=#{roleId}
	</update>
	<!-- 根据id查询角色信息 -->
	<select id="selectByPk" resultMap="roleMap" parameterType="string">
		select * from SYS_ROLE r
		left join sys_role_resource rr on rr.role_id = r.role_id
		left join sys_resource re on re.resource_id = rr.resource_id
		where r.role_id=#{roleId}
	</select>
	
	<!-- 根据项目Code获取个数 -->
	<select id="countByRoleCode" resultType="int" parameterType="string" >
		select count(*) from sys_role sr 
		<where>
			role_code = #{roleCode}
		</where>
	</select>

	
	<!-- 根据组织机构id查询角色信息 -->
	<select id="selectAllRoleByOrg" parameterType="string" resultMap="roleMap">
		select * from sys_role sr 
		<where>	
			sr.is_del != 1 and sr.role_type = 'app_level' and root_org_id = #{orgId}
		</where>
		order by sr.role_code
	</select>
	<!-- 根据角色类型查询角色信息 -->
	<select id="getRoleByRoleType" parameterType="string" resultMap="roleMap">
		select * from sys_role sr 
		<where>
			sr.role_type = #{roleType}
		</where>
	</select>
	
	<delete id="delete" parameterType="string">
		update SYS_ROLE set isDel=1 where role_id=#{role_id}
	</delete>
	
	
	
	
	
</mapper>