<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="DeliveryPacking">
    <resultMap id="deliveryPackingMap" type="DeliveryPacking">
        <id column="packing_id" property="packingId" jdbcType="OTHER"/>
        <result column="packing_no" property="packingNo" jdbcType="OTHER"/>
        <result column="packing_order" property="packingOrder" jdbcType="DECIMAL"/>
        <result column="delivery_id" property="deliveryId" jdbcType="OTHER"/>
        <result column="delivery_no" property="deliveryNo" jdbcType="VARCHAR"/>
        <result column="supplier_name" property="supplierName" jdbcType="OTHER"/>
        <result column="supplier_id" property="supplierId" jdbcType="OTHER"/>
        <result column="packing_state" property="packingState" jdbcType="OTHER"/>
        <result column="vehicle_id" property="vehicleId" jdbcType="OTHER"/>
        <result column="packing_type" property="packingType" jdbcType="OTHER"/>
        <result column="create_user_id" property="createUserId" jdbcType="OTHER"/>
        <result column="create_user_name" property="createUserName" jdbcType="OTHER"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="packing_weight" property="packingWeight"/>
        <result column="packing_size" property="packingSize"/>
        <result column="parent_id" property="_parentId" jdbcType="OTHER"/>
        <result column="is_receipt" property="isReceipt" jdbcType="OTHER"/>
    </resultMap>

    <resultMap id="deliveryPackingModalMap" type="DeliveryPacking">
        <id column="packing_id" property="packingId" jdbcType="OTHER"/>
        <result column="packing_no" property="packingNo" jdbcType="OTHER"/>
        <result column="delivery_id" property="deliveryId" jdbcType="OTHER"/>
        <result column="delivery_no" property="deliveryNo" jdbcType="VARCHAR"/>
        <result column="packing_type" property="packingType" jdbcType="OTHER"/>
        <result column="packing_weight" property="packingWeight"/>
        <result column="packing_size" property="packingSize"/>
        <collection property="childPacking" column="packing_id" select="selectChildPackageByParent"/>
        <collection property="deliveryPackageDetailList" column="packing_id"
                    select="DeliveryPackageDetail.queryDetailByPackageId"/>
    </resultMap>
    <!-- 根据发货单id查询发货包装信息 -->
    <select id="queryPackageByDeliveryId" resultMap="deliveryPackingMap" parameterType="string">
        SELECT * from p_delivery_packing pdp
        <where>
            pdp.delivery_id = #{deliveryId}
        </where>
    </select>

    <delete id="delDeliveryPackage" parameterType="string">
        delete from p_delivery_packing pdp
        <where>
            pdp.delivery_id = #{deliveryId}
        </where>
    </delete>
    <!-- 批量插入发货包装表 -->
    <insert id="insertList" parameterType="java.util.List" useGeneratedKeys="false">
        insert into p_delivery_packing
        (packing_id,packing_no,packing_order,delivery_id,delivery_no,supplier_name,supplier_id,packing_state,vehicle_id,
        packing_type,create_user_id,create_user_name,create_time,parent_id,packing_weight,packing_size,is_receipt)
        SELECT A.*
        FROM(
        <foreach collection="list" item="item" index="index" separator="UNION ALL">
            (SELECT
            #{item.packingId,jdbcType=VARCHAR} packing_id,
            #{item.packingNo,jdbcType=VARCHAR} packing_no,
            #{item.packingOrder,jdbcType=VARCHAR} packing_order,
            #{item.deliveryId,jdbcType=VARCHAR} delivery_id,
            #{item.deliveryNo,jdbcType=VARCHAR} delivery_no,
            #{item.supplierName,jdbcType=VARCHAR} supplier_name,
            #{item.supplierId,jdbcType=VARCHAR} supplier_id,
            #{item.packingState,jdbcType=VARCHAR} packing_state,
            #{item.vehicleId,jdbcType=VARCHAR} vehicle_id,
            #{item.packingType,jdbcType=VARCHAR} packing_type,
            #{item.createUserId,jdbcType=VARCHAR} create_user_id,
            #{item.createUserName,jdbcType=VARCHAR} create_user_name,
            #{item.createTime,jdbcType=TIMESTAMP} create_time,
            #{item._parentId,jdbcType=VARCHAR} parent_id,
            #{item.packingWeight,jdbcType=NUMERIC} packing_weight,
            #{item.packingSize,jdbcType=NUMERIC} packing_size,
            0 is_receipt
            FROM dual)
        </foreach>
        )A
    </insert>

    <!-- 分页查询发货单信息  -->
    <select id="countByCondition" resultType="int" parameterType="map">
        select count(1) from p_delivery_packing pdp1
        left join p_delivery_packing_detail pdpd on pdp1.packing_id = pdpd.packing_id
        left join p_order_detail pod on pdpd.doc_source_detail_id = pod.order_detail_id
        left join p_delivery pd on pdp1.delivery_id = pd.delivery_id
        <where>
            pdp1.parent_id = '0' and pdpd.doc_source_type = 'purchase' and pd.delivery_state = 'delivery' and pdp1.is_receipt = '0'
            <if test="DeliveryPackageCondition.deliveryNo!=null and DeliveryPackageCondition.deliveryNo!=''">and
                pdp1.delivery_no = #{DeliveryPackageCondition.deliveryNo}
            </if>
            <if test="DeliveryPackageCondition.supplierId!=null and DeliveryPackageCondition.supplierId!=''">and
                pdp1.supplier_id = #{DeliveryPackageCondition.supplierId}
            </if>
        </where>
    </select>
    <!-- 分页查询发货单信息  -->
    <select id="selectByCondition" resultMap="deliveryPackingModalMap" parameterType="map">
        select pd.delivery_no,pdp1.packing_no,pdp1.packing_type,pdp1.packing_weight,pdp1.packing_size,
        pdpd.*,pod.order_detail_count purchase_num from p_delivery_packing pdp1
        left join p_delivery_packing_detail pdpd on pdp1.packing_id = pdpd.packing_id
        left join p_order_detail pod on pdpd.doc_source_detail_id = pod.order_detail_id
        left join p_delivery pd on pdp1.delivery_id = pd.delivery_id
        <where>
            pdp1.parent_id = '0' and pdpd.doc_source_type = 'purchase' and pd.delivery_state = 'delivery' and pdp1.is_receipt = '0'
            <if test="DeliveryPackageCondition.deliveryNo!=null and DeliveryPackageCondition.deliveryNo!=''">and
                pd.delivery_no = #{DeliveryPackageCondition.deliveryNo}
            </if>
            <if test="DeliveryPackageCondition.supplierId!=null and DeliveryPackageCondition.supplierId!=''">and
                pdp1.supplier_id = #{DeliveryPackageCondition.supplierId}
            </if>
        </where>
    </select>

    <select id="selectChildPackageByParent" parameterType="string" resultMap="deliveryPackingModalMap">
    select * from p_delivery_packing where parent_id = #{packing_id}
  </select>
    <!-- 根据主键查询发货单信息 -->
    <select id="selectByPk" resultMap="deliveryPackingMap" parameterType="string">
        select * from p_delivery_packing
        <where>
            packing_id = #{packingId}
        </where>
    </select>
    <update id="update" parameterType="DeliveryPacking">
        update p_delivery_packing
        <set>
            is_receipt=#{isReceipt}
        </set>
        where  packing_id = #{packingId}
    </update>
</mapper>