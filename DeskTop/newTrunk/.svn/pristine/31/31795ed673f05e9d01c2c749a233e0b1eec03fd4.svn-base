<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="AgreementDetail" >
    <resultMap id="agreementDetailMap" type="AgreementDetail" >
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Feb 21 09:26:36 GMT+08:00 2017.
        -->
        <result column="agreement_id" property="agreementId"  />
        <result column="agreement_detail_id" property="agreementDetailId"  />
        <result column="agreement_detail_no" property="agreementDetailNo"  />
        <result column="agreement_detail_state" property="agreementDetailState"  />
        <result column="materials_id" property="materialsId"  />
        <result column="materials_code" property="materialsCode"  />
        <result column="number_main" property="numberMain"  />
        <result column="number_secondary" property="numberSecondary"  />
        <result column="currency" property="currency"  />
        <result column="unit_price" property="unitPrice"  />
        <result column="total_price" property="totalPrice"  />
        <result column="materials_describe" property="materialsDescribe"  />
        <result column="additional_1" property="additional1"  />
        <result column="additional_2" property="additional2"  />
        <result column="additional_3" property="additional3"  />
        <result column="additional_4" property="additional4"  />
        <result column="materials_unit_main" property="materialsUnitMain"  />
    </resultMap>


    <delete id="delete" parameterType="string">
        delete from p_framework_agreement_detail where agreement_id = #{agreementId}
    </delete>
    <!-- 查询全部条目 -->
    <select id="selectAll" resultMap="agreementDetailMap">
        select * from p_framework_agreement_detail
    </select>
    <!-- 根据条件查询条目 -->
    <select id="selectByCondition" resultMap="agreementDetailMap" parameterType="map">
        select *
        from (select p.agreement_detail_id,
        p.agreement_id,
        p.materials_id,
        p.materials_code,
        p.materials_describe,
        p.additional_1,
        p.additional_2,
        p.additional_3,
        p.additional_4,
        p.unit_price,
        p.total_price,
        p.number_main,
        p.materials_unit_main,
        ROW_NUMBER() OVER(order by p.agreement_id) r
        from p_framework_agreement_detail p
        left join p_framework_agreement pa
        on pa.agreement_id = p.agreement_id
        <where>

            <if test="AgreementDetailCondition!=null">
                <if test="AgreementDetailCondition.agreementId!=null and AgreementDetailCondition.agreementId!=''">
                    and p.agreement_id = #{AgreementDetailCondition.agreementId}
                </if>
                <if test="AgreementDetailCondition.numberMain!=null and AgreementDetailCondition.numberMain!=''">
                    and p.number_main = #{AgreementDetailCondition.numberMain}
                </if>
                <if test="AgreementDetailCondition.unitPrice!=null and AgreementDetailCondition.unitPrice!=''">
                    and p.unit_price = #{AgreementDetailCondition.unitPrice}
                </if>
                <if test="AgreementDetailCondition.totalPrice!=null and AgreementDetailCondition.totalPrice!=''">
                    and p.total_price = #{AgreementDetailCondition.totalPrice}
                </if>
                <if test="AgreementDetailCondition.materialsId!=null and AgreementDetailCondition.materialsId!=''">
                    and p.materials_id = #{AgreementDetailCondition.materialsId}
                </if>
                <if test="AgreementDetailCondition.materialsCode!=null and AgreementDetailCondition.materialsCode!=''">
                    and p.materials_code = #{AgreementDetailCondition.materialsCode}
                </if>
                <if test="AgreementDetailCondition.materialsDescribe!=null and AgreementDetailCondition.materialsDescribe!=''">
                    and p.materials_describe = #{AgreementDetailCondition.materialsDescribe}
                </if>
                <if test="AgreementDetailCondition.materialsUnitMain!=null and AgreementDetailCondition.materialsUnitMain!=''">
                    and p.materials_unit_main = #{AgreementDetailCondition.materialsUnitMain}
                </if>
                <if test="AgreementDetailCondition.additional1!=null and AgreementDetailCondition.additional1!=''">
                    and p.additional_1 = #{AgreementDetailCondition.additional1}
                </if>
                <if test="AgreementDetailCondition.additional2!=null and AgreementDetailCondition.additional2!=''">
                    and p.additional_2 = #{AgreementDetailCondition.additional2}
                </if>
                <if test="AgreementDetailCondition.additional3!=null and AgreementDetailCondition.additional3!=''">
                and p.additional_3 = #{AgreementDetailCondition.additional3}
                </if>
                <if test="AgreementDetailCondition.additional4!=null and AgreementDetailCondition.additional4!=''">
                and p.additional_4 = #{AgreementDetailCondition.additional4}
                </if>
                <if test="AgreementDetailCondition.agreementDetailList != null and AgreementDetailCondition.agreementDetailList.size>0">
                    and
                   p.agreement_id in
                    <foreach collection="AgreementDetailCondition.agreementDetailList" item="item" open="(" close=")"
                             separator=",">
                        #{item}
                    </foreach>
                </if>
            </if>
        </where>
        ) s

    </select>

    <!-- 根据条件查询条目数 -->
    <select id="countByCondition" resultType="int" parameterType="map">
        select count(*)
        from p_framework_agreement_detail p
        left join p_framework_agreement pa
        on p.agreement_id = pa.agreement_id
        <where>
            1=1
            <if test="AgreementDetailCondition!=null">
                <if test="AgreementDetailCondition.agreementCode!=null and AgreementDetailCondition.agreementCode!=''">
                    and pa.agreement_code = #{AgreementDetailCondition.agreementCode}
                </if>
                <if test="AgreementDetailCondition.agreementId!=null and AgreementDetailCondition.agreementId!=''">
                    and agreement_id = #{AgreementDetailCondition.agreementId}
                </if>
                <if test="AgreementDetailCondition.numberMain!=null and AgreementDetailCondition.numberMain!=''">
                    and number_main = #{AgreementDetailCondition.numberMain}
                </if>
                <if test="AgreementDetailCondition.unitPrice!=null and AgreementDetailCondition.unitPrice!=''">
                    and unit_price = #{AgreementDetailCondition.unitPrice}
                </if>
                <if test="AgreementDetailCondition.totalPrice!=null and AgreementDetailCondition.totalPrice!=''">
                    and total_price = #{AgreementDetailCondition.totalPrice}
                </if>
                <if test="AgreementDetailCondition.materialsId!=null and AgreementDetailCondition.materialsId!=''">
                    and materials_id = #{AgreementDetailCondition.materialsId}
                </if>
                <if test="AgreementDetailCondition.materialsCode!=null and AgreementDetailCondition.materialsCode!=''">
                    and materials_code = #{AgreementDetailCondition.materialsCode}
                </if>
                <if test="AgreementDetailCondition.materialsDescribe!=null and AgreementDetailCondition.materialsDescribe!=''">
                    and materials_describe = #{AgreementDetailCondition.materialsDescribe}
                </if>
                <if test="AgreementDetailCondition.materialsUnitMain!=null and AgreementDetailCondition.materialsUnitMain!=''">
                    and materials_unit_main = #{AgreementDetailCondition.materialsUnitMain}
                </if>
                <if test="AgreementDetailCondition.additional1!=null and AgreementDetailCondition.additional1!=''">
                    and additional_1 = #{AgreementDetailCondition.additional1}
                </if>
                <if test="AgreementDetailCondition.additional2!=null and AgreementDetailCondition.additional2!=''">
                    and additional_2 = #{AgreementDetailCondition.additional2}
                </if>
                <if test="AgreementDetailCondition.additional3!=null and AgreementDetailCondition.additional3!=''">
                and additional_3 = #{AgreementDetailCondition.additional3}
            </if>
                <if test="AgreementDetailCondition.additional4!=null and AgreementDetailCondition.additional4!=''">
                and additional_4 = #{AgreementDetailCondition.additional4}
            </if>
                <if test="AgreementDetailCondition.agreementDetailList != null and AgreementDetailCondition.agreementDetailList.size>0">
                    and
                    agreement_id in
                    <foreach collection="AgreementDetailCondition.agreementList" item="item" open="(" close=")"
                             separator=",">
                        #{item}
                    </foreach>
                </if>
            </if>
        </where>
    </select>
    <update id="update" parameterType="AgreementDetail" >
        update p_framework_agreement_detail
        <set>
            <if test="AgreementDetail!=null">
                <if test="materialsId!=null and materialsId!=''">
                    and materials_id = #{materialsId}
                </if>
                <if test="materialsCode!=null and materialsCode!=''">
                    and materials_code = #{materialsCode}
                </if>
                <if test="materialsDescribe!=null and materialsDescribe!=''">
                    and materials_describe = #{materialsDescribe}
                </if>
                <if test="additional1!=null and additional1!=''">
                    and additional_1 = #{additional1}
                </if>
                <if test="additional2!=null and additional2!=''">
                    and additional_2 = #{additional2}
                </if>
                <if test="additional3!=null and additional3!=''">
                    and additional_3 = #{additional3}
                </if>
                <if test="additional4!=null and additional4!=''">
                    and additional_4 = #{additional4}
                </if>
                <if test="materialsUnitMain!=null and materialsUnitMain!=''">
                    and materials_unit_main = #{materialsUnitMain}
                </if>
                <if test="numberMain!=null and numberMain!=''">
                    and number_main = #{numberMain}
                </if>
                <if test="currency!=null and currency!=''">
                    and currency = #{currency}
                </if>
                <if test="unitPrice!=null and unitPrice!=''">
                    and unit_price = #{unitPrice}
                </if>
                <if test="totalPrice!=null and totalPrice!=''">
                    and total_price = #{totalPrice}
                </if>

            </if>
        </set>

    </update>
    <!-- 批量插入物资明细表 -->
    <insert id="insertList" parameterType="java.util.List" useGeneratedKeys="false">
        insert into p_framework_agreement_detail
        (
        agreement_id,
        agreement_detail_id,
        materials_id,
        materials_code,
        materials_describe,
        additional_1,
        additional_2,
        additional_3,
        additional_4,
        materials_unit_main,
        number_main,
        number_secondary,
        unit_price,
        total_price
        )
        SELECT A.*
        FROM(
        <foreach collection="list" item="item" index="index" separator="UNION ALL">
            (SELECT
            #{item.agreementId} agreement_id,
            #{item.agreementDetailId} agreement_detail_id,
            #{item.materialsId} materials_id,
            #{item.materialsCode} materials_code,
            #{item.materialsDescribe} materials_describe,
            #{item.additional1} additional_1,
            #{item.additional2} additional_2,
            #{item.additional3} additional_3,
            #{item.additional4} additional_4,
            #{item.materialsUnitMain} materials_unit_main,
            #{item.numberMain} number_main,
            #{item.numberSecondary} number_secondary,
            #{item.unitPrice} unit_price,
            #{item.totalPrice} total_price
            FROM dual)
        </foreach>
        )A
    </insert>
    <!-- 根据组织机构id删除组织机构类型表 -->
    <delete id="deleteAgreementDetail " parameterType="string">
       delete  from p_framework_agreement_detail
        <where>
            agreement_id = #{agreementId}
        </where>
    </delete>

    <!-- 根据条件查询条目 -->
    <select id="selectByAgreementDetail" resultMap="agreementDetailMap" parameterType="map">
        select *
        from (select p.agreement_detail_id,
        p.agreement_id,
        pp.supplier_agreement_code,
        p.materials_id,
        p.materials_code,
        p.materials_describe,
        p.additional_1,
        p.additional_2,
        p.additional_3,
        p.additional_4,
        p.unit_price,
        p.total_price,
        p.number_main,
        p.materials_unit_main,
        ROW_NUMBER() OVER(order by p.agreement_id) r
        from p_framework_agreement_detail p
        left join p_framework_agreement pa
        on pa.agreement_id = p.agreement_id
        LEFT JOIN p_procurement_supplier pp
        ON pp.source_id = p.agreement_id
        left join p_order s
        ON s.order_id=p.agreement_id
        <where>
            pa.agreement_state='agreementCommit'
            <if test="AgreementDetailCondition!=null">
                <if test="AgreementDetailCondition.agreementId!=null and AgreementDetailCondition.agreementId!=''">
                    and p.agreement_id = #{AgreementDetailCondition.agreementId}
                </if>
                <if test="AgreementDetailCondition.supplier!=null and AgreementDetailCondition.supplier!=''">
                    and pp.supplier_org_id=#{AgreementDetailCondition.supplier}
                </if>
                <if test="AgreementDetailCondition.supplierAgreementCode!=null and AgreementDetailCondition.supplierAgreementCode!=''">
                    and pp.supplier_agreement_code like  '%'|| #{AgreementDetailCondition.supplierAgreementCode}
                </if>
                <if test="AgreementDetailCondition.materialsId!=null and AgreementDetailCondition.materialsId!=''">
                    and p.materials_id = #{AgreementDetailCondition.materialsId}
                </if>
                <if test="AgreementDetailCondition.materialsCode!=null and AgreementDetailCondition.materialsCode!=''">
                    and p.materials_code like  '%'|| #{AgreementDetailCondition.materialsCode} || '%'
                </if>
                <if test="AgreementDetailCondition.materialsDescribe!=null and AgreementDetailCondition.materialsDescribe!=''">
                    and p.materials_describe like  '%'|| #{AgreementDetailCondition.materialsDescribe} || '%'
                </if>
                <if test="AgreementDetailCondition.materialsUnitMain!=null and AgreementDetailCondition.materialsUnitMain!=''">
                    and p.materials_unit_main = #{AgreementDetailCondition.materialsUnitMain}
                </if>
                <if test="AgreementDetailCondition.agreementDetailList != null and AgreementDetailCondition.agreementDetailList.size>0">
                    and
                    p.agreement_id in
                    <foreach collection="AgreementDetailCondition.agreementDetailList" item="item" open="(" close=")"
                             separator=",">
                        #{item}
                    </foreach>
                </if>
            </if>
        </where>
        ) s
        where s.r between #{page.startPos} and ((#{page.pageSize}+#{page.startPos})-1)
    </select>

    <!-- 根据条件查询条目数 -->
    <select id="countByAgreementDetail" resultType="int" parameterType="map">
        select count(*)
        from p_framework_agreement_detail p
        left join p_framework_agreement pa
        on p.agreement_id = pa.agreement_id
        LEFT JOIN p_procurement_supplier pp
        ON pp.source_id = p.agreement_id
        left join p_order s
        ON s.order_id=p.agreement_id
        <where>
                pa.agreement_state='agreementCommit'
            <if test="AgreementDetailCondition!=null">
                <if test="AgreementDetailCondition.agreementId!=null and AgreementDetailCondition.agreementId!=''">
                    and p.agreement_id = #{AgreementDetailCondition.agreementId}
                </if>
                <if test="AgreementDetailCondition.supplier!=null and AgreementDetailCondition.supplier!=''">
                    and pp.supplier_org_id=#{AgreementDetailCondition.supplier}
                </if>
                <if test="AgreementDetailCondition.supplierAgreementCode!=null and AgreementDetailCondition.supplierAgreementCode!=''">
                    and pp.supplier_agreement_code like  '%'|| #{AgreementDetailCondition.supplierAgreementCode}
                </if>
                <if test="AgreementDetailCondition.materialsId!=null and AgreementDetailCondition.materialsId!=''">
                    and p.materials_id = #{AgreementDetailCondition.materialsId}
                </if>
                <if test="AgreementDetailCondition.materialsCode!=null and AgreementDetailCondition.materialsCode!=''">
                    and p.materials_code like  '%'|| #{AgreementDetailCondition.materialsCode} || '%'
                </if>
                <if test="AgreementDetailCondition.materialsDescribe!=null and AgreementDetailCondition.materialsDescribe!=''">
                    and p.materials_describe like  '%'|| #{AgreementDetailCondition.materialsDescribe} || '%'
                </if>
                <if test="AgreementDetailCondition.materialsUnitMain!=null and AgreementDetailCondition.materialsUnitMain!=''">
                    and p.materials_unit_main = #{AgreementDetailCondition.materialsUnitMain}
                </if>
                <if test="AgreementDetailCondition.agreementDetailList != null and AgreementDetailCondition.agreementDetailList.size>0">
                    and
                    p.agreement_id in
                    <foreach collection="AgreementDetailCondition.agreementDetailList" item="item" open="(" close=")"
                             separator=",">
                        #{item}
                    </foreach>
                </if>
            </if>
        </where>
    </select>
</mapper>