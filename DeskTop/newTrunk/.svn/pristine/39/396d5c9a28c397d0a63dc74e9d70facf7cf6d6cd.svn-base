<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Order">
    <resultMap type="Order" id="orderMap">
        <id column="order_id" property="orderId"/>
        <result column="order_code" property="orderCode"/>
        <result column="order_contract_no" property="orderContractNo"/>
        <result column="order_state" property="orderState"/>
        <result column="order_way" property="orderWay"/>
        <result column="data_to_sources" property="dataToSources"/>
        <result column="supplier_id" property="supplierId"/>
        <result column="supplier_name" property="supplierName"/>
        <result column="delivery_date" property="deliveryDate"/>
        <result column="create_date" property="createTime"/>
        <result column="create_user_id" property="createUserId"/>
        <result column="create_user_name" property="createUserName"/>
        <result column="order_opinion" property="orderOpinion"/>
    </resultMap>
    <!-- 根据条件分页查询条目 -->
    <select id="selectByCondition" resultMap="orderMap" parameterType="map">
        select * from(
        select
        order_id,order_code,order_contract_no,diccc.dictionary_name as order_state,
        dic.dictionary_name as order_way,data_to_sources,
        org.org_name as supplier_id,delivery_date,po.create_date,po.create_user_name,
        ROW_NUMBER() OVER(order by po.create_date desc) r
        from
        p_order po
        left join sys_org org
        on org.org_id = po.supplier_id
        left join sys_dictionary dic
        on dic.dictionary_code = po.order_way
        left join sys_dictionary diccc
        on diccc.dictionary_code = po.order_state
       <where>
            <if test="OrderCondition!=null">
                <if test="OrderCondition.orderCode != null and OrderCondition.orderCode != ''">
                    and order_code = #{OrderCondition.orderCode}
                </if>
                <if test="OrderCondition.orderContractNo != null and OrderCondition.orderContractNo != ''">
                    and order_contract_no = #{OrderCondition.orderContractNo}
                </if>
                <if test="OrderCondition.supplierName != null and OrderCondition.supplierName != ''">
                    and org.org_name = #{OrderCondition.supplierName}
                </if>
                <if test="OrderCondition.orderWay != null and OrderCondition.orderWay != ''">
                    and order_way = #{OrderCondition.orderWay}
                </if>
                <if test="OrderCondition.deliveryStartDate != null ">
                    and delivery_date &gt;= #{OrderCondition.deliveryStartDate}
                </if>
                <if test="OrderCondition.deliveryEndDate != null ">
                    and delivery_date &lt;= #{OrderCondition.deliveryEndDate}
                </if>
                <if test="OrderCondition.createStartTime != null ">
                    and create_date &gt;= #{OrderCondition.createStartTime}
                </if>
                <if test="OrderCondition.createEndTime != null ">
                    and create_date &lt;= #{OrderCondition.createEndTime}
                </if>
                <if test="OrderCondition.createUserName != null and OrderCondition.createUserName != ''">
                    and create_user_name = #{OrderCondition.createUserName}
                </if>
                <if test="OrderCondition.orderState != null and OrderCondition.orderState != ''">
                    and order_state = #{OrderCondition.orderState}
                </if>
            </if>
        </where>
        )s
        where  s.r between #{page.startPos} and ((#{page.pageSize}+#{page.startPos})-1)
    </select>

    <!-- 根据条件查询条目数 -->
    <select id="countByCondition" resultType="int" parameterType="map">
        select count(*)
        from
        p_order po
        left join sys_org org
        on org.org_id = po.supplier_id
        left join sys_dictionary dic
        on dic.dictionary_code = po.order_way
        left join sys_dictionary diccc
        on diccc.dictionary_code = po.order_state
        <where>
            <if test="OrderCondition!=null">
                <if test="OrderCondition.orderCode != null and OrderCondition.orderCode != ''">
                    and order_code = #{OrderCondition.orderCode}
                </if>
                <if test="OrderCondition.orderContractNo != null and OrderCondition.orderContractNo != ''">
                    and order_contract_no = #{OrderCondition.orderContractNo}
                </if>
                <if test="OrderCondition.supplierName != null and OrderCondition.supplierName != ''">
                    and org.org_name = #{OrderCondition.supplierName}
                </if>
                <if test="OrderCondition.orderWay != null and OrderCondition.orderWay != ''">
                    and order_way = #{OrderCondition.orderWay}
                </if>
                <if test="OrderCondition.deliveryStartDate != null ">
                    and delivery_date &gt;= #{OrderCondition.deliveryStartDate}
                </if>
                <if test="OrderCondition.deliveryEndDate != null ">
                    and delivery_date &lt;= #{OrderCondition.deliveryEndDate}
                </if>
                <if test="OrderCondition.createStartTime != null ">
                    and create_date &gt;= #{OrderCondition.createStartTime}
                </if>
                <if test="OrderCondition.createEndTime != null ">
                    and create_date &lt;= #{OrderCondition.createEndTime}
                </if>
                <if test="OrderCondition.createUserName != null and OrderCondition.createUserName != ''">
                    and create_user_name = #{OrderCondition.createUserName}
                </if>
                <if test="OrderCondition.orderState != null and OrderCondition.orderState != ''">
                    and order_state = #{OrderCondition.orderState}
                </if>
            </if>
        </where>
    </select>
    <delete id="delete" parameterType="string">
        delete from p_order where order_id = #{orderId}
    </delete>
    <!-- 根据ID查询单个实体 -->
    <select id="selectByPk" resultMap="orderMap" parameterType="string">
        select * from p_order where order_id = #{orderId}
    </select>
    <!-- 编辑 -->
    <update id="update" parameterType="Order">
        update p_order
        <set>
            order_code = #{orderCode}, order_contract_no = #{orderContractNo},
            order_way = #{orderWay}, data_to_sources = #{dataToSources},
            <if test="orderState!=null and orderState!=''">order_state = #{orderState},</if>
            <if test="orderOpinion!=null and orderOpinion!=''">order_opinion = #{orderOpinion},</if>
            supplier_id = #{supplierId}, delivery_date = #{deliveryDate},supplier_name = #{supplierName}
        </set>
        where order_id = #{orderId}
    </update>
    <!-- 插入仓库信息 -->
    <insert id="insert" parameterType="Order" useGeneratedKeys="false">
        insert into p_order (
        order_id,order_code,
        order_contract_no,order_way,
        data_to_sources,supplier_id,
        delivery_date,order_state,
        order_opinion,create_date,
        create_user_id,create_user_name,supplier_name
        ) values (
        #{orderId},#{orderCode},
        #{orderContractNo},#{orderWay},
        #{dataToSources},#{supplierId},
        #{deliveryDate},#{orderState},
        #{orderOpinion},#{createTime},
        #{createUserId},#{createUserName},#{supplierName}
        )
    </insert>
    <select id="selectBySupplier" resultMap="orderMap" parameterType="map">
        select * from p_order where order_state='orderPass'
        <if test="supplier!=null and supplier!=''">
         and supplier_id = #{supplier}
        </if>
    </select>
</mapper>