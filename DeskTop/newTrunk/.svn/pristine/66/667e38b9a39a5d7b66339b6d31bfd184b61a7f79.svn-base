<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="Materials">

	<resultMap type="Materials" id="materialsMap">
		<id column="materials_id" property="materialsId"/>
		<result column="materials_code" property="materialsCode" />
		<result column="materials_describe" property="materialsDescribe" />
		<result column="materials_state" property="materialsState" />
		<result column="materials_unit_main" property="materialsUnitMain" />
		<result column="materials_unit_secondary" property="materialsUnitSecondary" />
		<result column="materials_conversion" property="conversion" />
		<result column="temp_mark" property="tempMark" />
		<result column="materials_category" property="materialsCategory" />
		<result column="wbs_code" property="wbsCode" />
		<result column="is_del" property="isdel" />
		<result column="materials_name" property="materialsName" />
		<result column="additional_1" property="additional1" />
		<result column="additional_2" property="additional2" />
		<result column="additional_3" property="additional3" />
		<result column="additional_4" property="additional4" />
	</resultMap>
	
	<sql id="column">
		m.materials_id, m.materials_code, m.materials_describe,
		m.materials_state, m.materials_conversion, m.temp_mark, m.wbs_code, m.is_del,m.materials_name,
		m.additional_1,m.additional_2,m.additional_3,m.additional_4
	</sql>
	
	<!-- 查询全部条目 -->
	<select id="selectAll" resultMap="materialsMap">
		select * from b_materials where is_del='1'
	</select>
	
	<!-- 根据条件分页查询条目 -->
	<select id="selectByCondition" resultMap="materialsMap" parameterType="map">
		select * from(
			select
			<include refid="column" />,m.materials_category,
			Munit.dictionary_name as materials_unit_main,
			ROW_NUMBER() OVER(order by m.materials_id) r
			from b_materials m
			left join sys_dictionary Munit
			on Munit.dictionary_code = m.materials_unit_main
			<where>
				m.is_del = '1' and Munit.is_del='1'
				<if test="MaterialsCondition!=null">
					<if test="MaterialsCondition.materialsCode!=null and MaterialsCondition.materialsCode!=''">
						and m.materials_code like  '%'|| #{MaterialsCondition.materialsCode} || '%'
					</if>
					<if test="MaterialsCondition.materialsState!=null and MaterialsCondition.materialsState!=''">
						and m.materials_state = #{MaterialsCondition.materialsState}
					</if>
					<if test="MaterialsCondition.materialsDescribe!=null and MaterialsCondition.materialsDescribe!=''">
						and m.materials_describe like  '%'|| #{MaterialsCondition.materialsDescribe} || '%'
					</if>
					<if test="MaterialsCondition.materialsCategory!=null and MaterialsCondition.materialsCategory!=''">
						and m.materials_category = #{MaterialsCondition.materialsCategory}
					</if>
					<if test="MaterialsCondition.materialsState!=null and MaterialsCondition.materialsState!=''">
						and m.materials_state = #{MaterialsCondition.materialsState}
					</if>
				</if>
			</where>
		) s
		where s.r between #{page.startPos} and ((#{page.pageSize}+#{page.startPos})-1)
	</select>
	
	<!-- 根据条件查询条目数 -->
	<select id="countByCondition" resultType="int" parameterType="map">
		select count(*)
		from b_materials m
		left join sys_dictionary Munit
		on Munit.dictionary_code = m.materials_unit_main
		<where>
			m.is_del = '1' and Munit.is_del='1'
			<if test="MaterialsCondition!=null">
				<if test="MaterialsCondition.materialsCode!=null and MaterialsCondition.materialsCode!=''">
					and m.materials_code = #{MaterialsCondition.materialsCode}
				</if>
				<if test="MaterialsCondition.materialsState!=null and MaterialsCondition.materialsState!=''">
					and m.materials_state = #{MaterialsCondition.materialsState}
				</if>
				<if test="MaterialsCondition.materialsDescribe!=null and MaterialsCondition.materialsDescribe!=''">
					and m.materials_describe = #{MaterialsCondition.materialsDescribe}
				</if>
				<if test="MaterialsCondition.materialsCategory!=null and MaterialsCondition.materialsCategory!=''">
					and m.materials_category = #{MaterialsCondition.materialsCategory}
				</if>
				<if test="MaterialsCondition.materialsState!=null and MaterialsCondition.materialsState!=''">
					and m.materials_state = #{MaterialsCondition.materialsState}
				</if>
			</if>
		</where>
	</select>
	
	<!-- 根据ID查询单个实体 -->
	<select id="selectByPk" resultMap="materialsMap" parameterType="string">
		select * from b_materials m where m.is_del = '1' and m.materials_id = #{materialsId}
	</select>
	
	<!-- 插入一个实体 -->
	<insert id="insert" parameterType="Materials" useGeneratedKeys="false">
		insert into b_materials(
			materials_id, materials_code, materials_describe,
			materials_state, temp_mark, wbs_code, is_del, materials_category,
			materials_unit_main,materials_name,additional_1,additional_2,additional_3,additional_4
		) values(
			#{materialsId}, #{materialsCode}, #{materialsDescribe},
			#{materialsState}, #{tempMark}, #{wbsCode}, #{isdel}, #{materialsCategory},
			#{materialsUnitMain}, #{materialsName},#{additional1},#{additional2},#{additional3},#{additional4}
		)
	</insert>

	<!-- 批量插入组织机构类型表 -->
	<insert id="insertList" parameterType="java.util.List" useGeneratedKeys="false">
		insert into b_materials(
			materials_id, materials_code, materials_describe,
			materials_state, temp_mark, wbs_code, is_del, materials_category,
			materials_unit_main,materials_name,additional_1,additional_2,additional_3,additional_4
		)
		SELECT A.*
		FROM(
		<foreach collection="list" item="item" index="index" separator="UNION ALL">
			(SELECT
			#{item.materialsId,jdbcType=VARCHAR} materials_id,
			#{item.materialsCode,jdbcType=VARCHAR} materials_code,
			#{item.materialsDescribe,jdbcType=VARCHAR} materials_describe,
			#{item.materialsState,jdbcType=VARCHAR} materials_state,
			#{item.tempMark,jdbcType=VARCHAR} temp_mark,
			#{item.wbsCode,jdbcType=VARCHAR} wbs_code,
			#{item.isdel,jdbcType=VARCHAR} is_del,
			#{item.materialsCategory,jdbcType=VARCHAR} materials_category,
			#{item.materialsUnitMain,jdbcType=VARCHAR} materials_unit_main,
			#{item.materialsName,jdbcType=VARCHAR} materials_name,
			#{item.additional1,jdbcType=CHAR} additional_1,
			#{item.additional2,jdbcType=VARCHAR} additional_2,
			#{item.additional3,jdbcType=VARCHAR} additional_3,
			#{item.additional4,jdbcType=CHAR} additional_4,
			FROM dual)
		</foreach>
		) A
	</insert>


	<!-- 更新一个实体 -->
	<update id="update" parameterType="Materials" >
		update b_materials
		<set>
			<if test="materialsCategory!=null and materialsCategory!=''">materials_category = #{materialsCategory},</if>
			<if test="tempMark!=null and tempMark!=''">temp_mark = #{tempMark},</if>
			<if test="materialsUnitMain!=null and materialsUnitMain!=''">materials_unit_main = #{materialsUnitMain},</if>
			<if test="materialsUnitSecondary!=null and materialsUnitSecondary!=''">materials_unit_secondary = #{materialsUnitSecondary},</if>
			<if test="conversion!=null and conversion!=''">materials_conversion = #{conversion},</if>
			<if test="materialsState!=null and materialsState!=''">materials_state = #{materialsState},</if>
			<if test="materialsDescribe!=null and materialsDescribe!=''">materials_describe = #{materialsDescribe},</if>
			materials_name = #{materialsName},additional_1=#{additional1},additional_2=#{additional2},
			additional_3 = #{additional3},additional_4 = #{additional4}
		</set>
		where materials_id = #{materialsId}
	</update>
	<!-- 根据用户名校验用户名是否重复 返回数量-->
	<select id="checkMaterials" resultType="int" parameterType="string">
		select count(*) from b_materials bm
		<where>
			bm.materials_code=#{materialsCode} and bm.is_del='1'
		</where>
	</select>

	<!-- 根据用户名校验用户名是否重复  返回实体-->
	<select id="selectByCode" resultMap="materialsMap" parameterType="string">
		select * from b_materials bm
		<where>
			bm.materials_code=#{materialsCode}
		</where>
	</select>

	<!-- 根据设计院设备编码查询重复的部件记录 -->
	<select id="findRepeatParts" resultMap="materialsMap" parameterType="string">
		select *
		from b_materials
		where
		   materials_code || ',' || materials_describe  || ',' ||
		   materials_unit_main || ',' || materials_conversion || ',' ||
		   materials_category || ',' || wbs_code || ',' ||
		   materials_name || ',' || additional_1 || ',' ||
		   additional_2 || ',' || additional_3 || ',' || additional_4 =
		   (  select *
			  from (
					(SELECT to_char(
									  #{DesignParts.designCode} || ',' || #{DesignParts.designDescribe} || ',' || #{DesignParts.designUnitMain} || ',' ||
									  #{DesignParts.designConversion} || ',' || #{DesignParts.designType} || ',' ||
									  #{DesignParts.wbsCode} || ',' || #{DesignParts.designName} || ',' ||
									  #{DesignParts.additional1} || ',' || #{DesignParts.additional2} || ',' || #{DesignParts.additional3} || ',' ||
									  #{DesignParts.additional4}
									) as a
					 FROM dual)
			  )
			  INTERSECT
			  		select to_char(
							   materials_code || ',' || materials_describe || ',' ||
							   materials_unit_main || ',' || materials_conversion || ',' ||
							   materials_category || ',' || wbs_code || ',' ||
							   materials_name || ',' || additional_1 || ',' ||
							   additional_2 || ',' || additional_3 || ',' || additional_4
							 ) as a
			  from b_materials  m
			  left join b_materials_attachment ma
			  on m.materials_id = ma.materials_m_id
			  where ma.materials_e_id = #{materialsId}
		   )
	</select>

	<!-- 根据设计院编码查询已有条目 -->
	<select id="select4design" resultMap="materialsMap" parameterType="map">
		select *
		from b_materials m
		left join b_materials_attachment ma
		on m.materials_id = ma.materials_e_id
		<where>
			rownum = 1
			<if test="designCode!=null and designCode!=''">
				and m.materials_code = #{designCode}
			</if>
			<if test="equipmentNo!=null and equipmentNo!=''">
				and ma.equipment_no = #{equipmentNo}
			</if>
			<if test="designDescribe!=null and designDescribe!=''">
				and m.materials_describe = #{designDescribe}
			</if>
			<if test="additional1!=null and additional1!=''">
				and m.additional_1 = #{additional1}
			</if>
			<if test="additional2!=null and additional2!=''">
				and m.additional_2 = #{additional2}
			</if>
			<if test="additional3!=null and additional3!=''">
				and m.additional_3 = #{additional3}
			</if>
			<if test="additional4!=null and additional4!=''">
				and m.additional_4 = #{additional4}
			</if>
		</where>
	</select>

	<!-- 更新一个实体 -->
	<update id="markDelete" parameterType="string" >
		update b_materials
		<set>
			is_del = '0'
		</set>
		where materials_id = #{materialsId}
	</update>

</mapper>