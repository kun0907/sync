<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Log">
	<resultMap type="Log" id="logMap">
		<id column="log_id" property="log_id"/>
		<result column="log_name" property="log_name"/>
		<result column="log_context" property="log_context"/>
		<result column="log_user" property="log_user"/>
		<result column="log_IP" property="log_IP"/>
		<result column="log_date" property="log_date"/>
		<result column="log_type" property="log_type"/>
		<result column="r" property="log_order"/>
	</resultMap>
	<!-- 新增日志 --> 
	<insert id="insert" parameterType="Log" >
		insert into sys_log  (
			log_id,log_name,log_context,log_user,log_IP,log_date,log_type
		) values (
			#{log_id},#{log_name},#{log_context},#{log_user},#{log_IP},CONVERT(varchar(100), #{log_date}, 121),#{log_type}
		)
	</insert>
	<!-- 根据id查看日志内容 --> 
 	<select id="selectByPk" parameterType="string" resultMap="logMap">
		select sl.log_context from sys_log sl where sl.log_id = #{log_id} 
	</select>	
	
	<!-- 查询日志 -->
	<select id="selectByCondition" resultMap="logMap" parameterType="Map">
		select * from(
			select lg.*,ROW_number()OVER(order by lg.log_id) r from SYS_LOG lg
			<where>
				<if test="LogForm.log_name!=null and LogForm.log_name!=''">lg.log_name like '%'||#{LogForm.log_name}||'%'</if>
				<if test="LogForm.log_context!=null and LogForm.log_context!=''">and lg.log_context like '%'||#{LogForm.log_context}||'%'</if>
				<if test="LogForm.log_user!=null and LogForm.log_user!=''">and lg.log_user like '%'||#{LogForm.log_user}||'%'</if>
				<if test="LogForm.log_IP!=null and LogForm.log_IP!=''">and lg.log_IP like '%'||#{LogForm.log_IP}||'%'</if>
				<if test="LogForm.beginTime != null and LogForm.beginTime != '' and LogForm.endTime != null and LogForm.endTime != ''">
					and(<![CDATA[ #{LogForm.beginTime}<=lg.log_date AND lg.log_date<=#{LogForm.endTime} ]]>)
				</if>
				<if test="LogForm.log_type!=null and LogForm.log_type!=''">and lg.log_type like '%'||#{LogForm.log_type}||'%'</if>
			</where>
		)s where s.r between #{page.startPos} and ((#{page.pageSize}+#{page.startPos})-1) order by r
	</select>
	<select id="countByCondition" resultType="int" parameterType="map">
		select count(*) from SYS_LOG lg
		<where>
			<if test="LogForm.log_name!=null and LogForm.log_name!=''">lg.log_name like '%'||#{LogForm.log_name}||'%'</if>
			<if test="LogForm.log_context!=null and LogForm.log_context!=''">and lg.log_context like '%'||#{LogForm.log_context}||'%'</if>
			<if test="LogForm.log_user!=null and LogForm.log_user!=''">and lg.log_user like '%'||#{LogForm.log_user}||'%'</if>
			<if test="LogForm.log_IP!=null and LogForm.log_IP!=''">and lg.log_IP like '%'||#{LogForm.log_IP}||'%'</if>
			<if test="LogForm.beginTime != null and LogForm.beginTime != '' and LogForm.endTime != null and LogForm.endTime != ''">
				and(<![CDATA[ #{LogForm.beginTime}<=lg.log_date AND lg.log_date<=#{LogForm.endTime} ]]>)
			</if>
			<if test="LogForm.log_type!=null and LogForm.log_type!=''">and lg.log_type like '%'||#{LogForm.log_type}||'%'</if>
		</where>
	</select>	

</mapper>