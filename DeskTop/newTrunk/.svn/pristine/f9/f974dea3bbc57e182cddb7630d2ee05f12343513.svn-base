<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="DemandPlan" >
    <resultMap type="DemandPlan" id="demandPlanMap">
        <id column="demand_id" property="demandId"/>
        <result column="demand_code" property="demandCode"/>
        <result column="is_change" property="isChange"/>
        <result column="create_time" property="createTime"/>
        <result column="create_user_id" property="createUserId"/>
        <result column="create_user_name" property="createUserName"/>
        <result column="demand_source" property="demandSource"/>
        <result column="data_source" property="dataSource"/>
        <result column="demand_state" property="demandState"/>
        <result column="demand_org_id" property="demandOrgId"/>
        <result column="demand_direction" property="demandDirection"/>
        <result column="wbs_id" property="wbsId"/>
        <result column="wbs_code" property="wbsCode"/>
        <result column="wbs_name" property="wbsName"/>
        <result column="reason" property="reason"/>
        <result column="change_reason" property="changeReason"/>
    </resultMap>
    <!-- 根据条件分页查询条目 -->
    <select id="selectByCondition" resultMap="demandPlanMap" parameterType="map">
        select * from(
        select
        demand_id,demand_code,is_change,od.create_time,od.create_user_id,od.create_user_name,
        demand_source,data_source,demand_state,org.org_name as demand_org_id,demand_direction,od.wbs_code,wbs_id,
        od.wbs_name,reason,change_reason,
        ROW_NUMBER() OVER(order by od.demand_id) r
        from
        out_demand_plan od
        left join sys_org org
        on od.demand_org_id=org.org_id
       <where>
            <if test="DemandPlanCondition!=null">
                <if test="DemandPlanCondition.demandState != null and DemandPlanCondition.demandState != ''">
                    and demand_state = #{DemandPlanCondition.demandState}
                </if>
                <if test="DemandPlanCondition.demandCode != null and DemandPlanCondition.demandCode != ''">
                    and demand_code = #{DemandPlanCondition.demandCode}
                </if>
                <if test="DemandPlanCondition.demandSource != null and DemandPlanCondition.demandSource != ''">
                    and demand_source = #{DemandPlanCondition.demandSource}
                </if>
                <if test="DemandPlanCondition.createStartTime != null ">
                    and od.create_time &gt;= #{DemandPlanCondition.createStartTime}
                </if>
                <if test="DemandPlanCondition.createEndTime != null ">
                    and od.create_time &lt;= #{DemandPlanCondition.createEndTime}
                </if>
                <if test="DemandPlanCondition.createUserName != null and DemandPlanCondition.createUserName != ''">
                    and od.create_user_name = #{DemandPlanCondition.createUserName}
                </if>
                <if test="DemandPlanCondition.demandOrgId != null and DemandPlanCondition.demandOrgId != ''">
                    and demand_org_id = #{DemandPlanCondition.demandOrgId}
                </if>
                <if test="DemandPlanCondition.wbsCode != null and DemandPlanCondition.wbsCode != ''">
                    and od.wbs_code = #{DemandPlanCondition.wbsCode}
                </if>
            </if>
        </where>
        )s
        where  s.r between #{page.startPos} and ((#{page.pageSize}+#{page.startPos})-1)
    </select>

    <!-- 根据条件查询条目数 -->
    <select id="countByCondition" resultType="int" parameterType="map">
        select count(*)
        from
        out_demand_plan od
        <where>
            <if test="DemandPlanCondition!=null">
                <if test="DemandPlanCondition.demandState != null and DemandPlanCondition.demandState != ''">
                    and demand_state = #{DemandPlanCondition.demandState}
                </if>
                <if test="DemandPlanCondition.demandCode != null and DemandPlanCondition.demandCode != ''">
                    and demand_code = #{DemandPlanCondition.demandCode}
                </if>
                <if test="DemandPlanCondition.demandSource != null and DemandPlanCondition.demandSource != ''">
                    and demand_source = #{DemandPlanCondition.demandSource}
                </if>
                <if test="DemandPlanCondition.createStartTime != null ">
                    and create_time &gt;= #{DemandPlanCondition.createStartTime}
                </if>
                <if test="DemandPlanCondition.createEndTime != null ">
                    and create_time &lt;= #{DemandPlanCondition.createEndTime}
                </if>
                <if test="DemandPlanCondition.createUserName != null and DemandPlanCondition.createUserName != ''">
                    and create_user_name = #{DemandPlanCondition.createUserName}
                </if>
                <if test="DemandPlanCondition.demandOrgId != null and DemandPlanCondition.demandOrgId != ''">
                    and demand_org_id = #{DemandPlanCondition.demandOrgId}
                </if>
                <if test="DemandPlanCondition.wbsCode != null and DemandPlanCondition.wbsCode != ''">
                    and wbs_code = #{DemandPlanCondition.wbsCode}
                </if>
            </if>
        </where>
    </select>
    <delete id="delete" parameterType="string">
        delete from out_demand_plan od where demand_id = #{demandId}
    </delete>
    <!-- 根据ID查询单个实体 -->
    <select id="selectByPk" resultMap="demandPlanMap" parameterType="string">
        select * from out_demand_plan od where demand_id = #{demandId}
    </select>
    <update id="update" parameterType="DemandPlan">
        update out_demand_plan
        <set>
            demand_source = #{demandSource},data_source = #{dataSource},
            demand_org_id = #{demandOrgId}, demand_direction = #{demandDirection},
            <if test="demandState!=null and demandState!=''">demand_state = #{demandState},</if>
            <if test="isChange!=null and isChange!=''">is_change = #{isChange},</if>
            <if test="reason!=null and reason!=''">reason = #{reason},</if>
            wbs_code = #{wbsCode}, wbs_name = #{wbsName}, wbs_id = #{wbsId}, change_reason = #{changeReason}
        </set>
        where demand_id = #{demandId}
    </update>
    <!-- 插入需用计划信息 -->
    <insert id="insert" parameterType="DemandPlan" useGeneratedKeys="false">
        insert into out_demand_plan (
        demand_id,demand_code,
        is_change,create_time,
        create_user_id,create_user_name,
        demand_source,data_source,
        demand_state,demand_org_id,
        demand_direction,wbs_code,wbs_name,reason,wbs_id,change_reason
        ) values (
        #{demandId},#{demandCode},
        #{isChange},#{createTime},
        #{createUserId},#{createUserName},
        #{demandSource},#{dataSource},
        #{demandState},#{demandOrgId},
        #{demandDirection},#{wbsCode},#{wbsName},#{reason},#{wbsId},#{changeReason}
        )
    </insert>
</mapper>