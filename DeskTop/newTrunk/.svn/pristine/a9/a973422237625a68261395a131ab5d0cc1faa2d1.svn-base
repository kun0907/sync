<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

	<mapper namespace="Organization" >
		<resultMap type="Organization" id="organizationMap">
			<id column="org_id" property="orgId"/>
			<result column="org_code" property="orgCode"/>
			<result column="org_name" property="orgName"/>
			<result column="org_order" property="orgOrder"/>
			<result column="org_isdel" property="isDel"/>
			<result column="org_level" property="level"/>
			<result column="is_leaf" property="isLeaf"/>
			<result column="parent_id" property="parentId"/>
			<result column="root_id" property="rootOrgId"/>
			<result column="is_validate" property="isValidate"/>
			<result column="create_user_name" property="createUserName"/>
			<result column="create_user_id" property="createUserId"/>
			<result column="create_time" property="createTime"/>
			<result column="org_seq" property="orgSeq"/>
			<collection property="orgTypeList" column="org_id" select="OrganizationType.selectOrgType"/>
			<collection property="orgTypeWBSList" column="org_id" select="OrganizationTypeWBS.selectOrgTypeWBSByOrgId"/>
			<!--<collection property="wareHouseOrgList" column="org_id"  select="WarehouseOrg.selectWareHouseByOrg"></collection>-->
		</resultMap>

		<sql id="all">so.org_id,org_code,org_name,org_order,org_isdel,parent_id,org_level,is_leaf,root_id,create_user_name,create_user_id,create_time,is_validate</sql>

		<!-- 获取所有的组织结构信息 -->
		<select id="selectAll" resultMap="organizationMap" parameterType="string">
			select * from sys_org so 
			<where>
				so.is_validate = '1' and org_isdel = '0'
			</where>
		</select>
		<!-- 根据当前登录用户所属的部门 -->
		<select id="selectOrgByUser" resultMap="organizationMap" parameterType="string" >
			select * from sys_org so 
			<where>
				so.org_seq like '%' || #{currentOrg} || '%'
				and org_isdel = '0'
			</where>
		</select>
		<!-- 分页组织机构数量 -->
		<select id="countByCondition" resultType="int" parameterType="map">
			select count(*) from(
				select so.org_id,so.org_code,so.org_order,so.org_name,so.is_validate,so.org_level, wm_concat(to_char(DICTIONARY_NAME)) as type_name,
				wm_concat(to_char(DICTIONARY_code))  as type_code,ROW_NUMBER() OVER(order by so.create_time desc) r
				from  sys_org so left join sys_org_type sot on so.ORG_ID = sot.ORG_ID
				left join sys_dictionary sd on  sot.org_type = sd.dictionary_code
				<where>
					so.org_isdel = '0'
					<if test="OrganizationCondition.parentId!=null and OrganizationCondition.parentId!=''"> and so.org_seq like '%' || #{OrganizationCondition.parentId} || '%' and so.org_id != #{OrganizationCondition.parentId}</if>
					<if test="OrganizationCondition.orgId!=null and OrganizationCondition.orgId!=''">and so.org_seq like '%' || #{OrganizationCondition.orgId} || '%'</if>
					<if test="OrganizationCondition.orgCode!=null and OrganizationCondition.orgCode!=''"> and so.org_code = #{OrganizationCondition.orgCode}</if>
					<if test="OrganizationCondition.orgName!=null and OrganizationCondition.orgName!=''"> and so.org_name like '%' || #{OrganizationCondition.orgName} || '%'</if>
					<if test="OrganizationCondition.orgType!=null and OrganizationCondition.orgType!=''"> and sot.org_type = #{OrganizationCondition.orgType}</if>
					<if test="OrganizationCondition.orgState!=null and OrganizationCondition.orgState!=''">and so.is_validate = #{OrganizationCondition.orgState}</if>
				</where>
				group by so.org_id,so.org_code,so.org_order,so.org_name,so.create_time,so.is_validate,so.org_level
			)
		</select>

		<!-- 分页查询组织机构信息  -->
		<select id="selectByCondition" resultType="java.util.HashMap" parameterType="map">
			select * from (
				select so.org_id,so.org_code,so.org_order,so.org_name,so.is_validate,so.org_level, wm_concat(to_char(DICTIONARY_NAME)) as type_name,
				wm_concat(to_char(DICTIONARY_code))  as type_code,ROW_NUMBER() OVER(order by so.create_time desc) r    
				from  sys_org so left join sys_org_type sot on so.ORG_ID = sot.ORG_ID
				left join sys_dictionary sd on  sot.org_type = sd.dictionary_code 
				<where>
					so.org_isdel = '0'
					<if test="OrganizationCondition.parentId!=null and OrganizationCondition.parentId!=''"> and so.org_seq like '%' || #{OrganizationCondition.parentId} || '%' and so.org_id != #{OrganizationCondition.parentId}</if>
					<if test="OrganizationCondition.orgId!=null and OrganizationCondition.orgId!=''">and so.org_seq like '%' || #{OrganizationCondition.orgId} || '%'</if>
					<if test="OrganizationCondition.orgCode!=null and OrganizationCondition.orgCode!=''"> and so.org_code = #{OrganizationCondition.orgCode}</if>
					<if test="OrganizationCondition.orgName!=null and OrganizationCondition.orgName!=''"> and so.org_name like '%' || #{OrganizationCondition.orgName} || '%'</if>		
					<if test="OrganizationCondition.orgType!=null and OrganizationCondition.orgType!=''"> and sot.org_type = #{OrganizationCondition.orgType}</if>		
					<if test="OrganizationCondition.orgState!=null and OrganizationCondition.orgState!=''">and so.is_validate = #{OrganizationCondition.orgState}</if>		
				</where>
				group by so.org_id,so.org_code,so.org_order,so.org_name,so.create_time,so.is_validate,so.org_level 
			) s where s.r between #{page.startPos} and ((#{page.pageSize}+#{page.startPos})-1)  
		</select>
		
		<!-- 根据组织机构Code获取个数 -->
		<select id="countByOrgCode" resultType="int" parameterType="string" >
			select count(*) from sys_org so 
			<where>
				org_code = #{orgCode} 
			</where>
		</select>
		
		<!-- 插入组织机构信息 -->
		<insert id="insert" useGeneratedKeys="false">
			insert into sys_org (
				org_id,org_code,org_name,org_order,org_isdel,parent_id,org_level,is_leaf,root_id,create_user_name,create_user_id,create_time,org_seq,is_validate
			) values (
				#{orgId},#{orgCode},#{orgName},#{orgOrder},#{isDel},#{parentId},#{level},#{isLeaf},#{rootOrgId},#{createUserName},#{createUserId},sysdate,#{orgSeq},#{isValidate}
			)
		</insert>
		<!-- 更新组织机构信息 -->
		<update id="update">
			update sys_org 
			<set>   
				<if test="level!= null and level!=''">org_level = #{level},</if>
				<if test="orgName!= null and orgName!=''">org_name = #{orgName},</if>
				<if test="orgOrder!= null and orgOrder!=''">org_order = #{orgOrder},</if>
				<if test="isDel!= null and isDel!=''">org_isdel = #{isDel},</if>
				<if test="isLeaf!= null and isLeaf!=''">is_leaf = #{isLeaf},</if>
				<if test="isValidate!= null and isValidate!=''">is_validate = #{isValidate},</if>
				org_id = #{orgId}
			</set>
			where org_id = #{orgId}
		</update>
		<!-- 根据主键查询组织机构信息 -->
		<select id="selectByPk" resultMap="organizationMap" parameterType="string">
			select so.parent_id,so.org_id,so.org_code,so.org_order,so.org_name,so.is_validate,so.org_level,to_char(so.org_seq) as org_seq,so.is_leaf,so.root_id,
				wm_concat(to_char(DICTIONARY_code))  as type_code
				from      sys_org so left join sys_org_type sot on so.org_id = sot.org_id
				left join sys_dictionary sd on sot.org_type = sd.dictionary_code
        		<where>
					so.org_id = #{orgId}
        		</where> 
      			group by so.parent_id,so.org_id,so.org_code,so.org_order,so.org_name,so.create_time,so.is_validate,so.org_level,to_char(so.org_seq),so.is_leaf,so.root_id
		</select>
		<!-- 根据组织id查询子组织信息 -->
		<select id="getSubOrg" resultMap="organizationMap" parameterType="string">
			select * from sys_org so 
			<where>
				so.parent_id = #{orgId} and so.org_isdel='0'
			</where>
		</select>
		<!-- 根据组织机构类别查询组织机构信息 -->
		<select id="selectOrgByType" resultMap="organizationMap" parameterType="string">
			select so.* from sys_org so 
			left join sys_org_type sot on so.org_id = sot.org_id
			<where>
				sot.org_type = #{orgTypeCode} and so.org_isdel='0' and is_validate='1'
			</where>
		</select>
		<select id="selectChildOrgByParent" parameterType="string" resultMap="organizationMap">
			select * from sys_org so where so.parent_id = #{org_id}
		</select>
	</mapper>
