<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="Agreement" >
    <resultMap id="agreementMap" type="Agreement" >
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Feb 21 09:31:59 GMT+08:00 2017.
        -->
        <result column="agreement_id" property="agreementId" />
        <result column="agreement_code" property="agreementCode"/>
        <result column="agreement_state" property="agreementState"/>
        <result column="perform_start_date" property="performStartDate"/>
        <result column="perform_end_date" property="performEndDate"/>
        <result column="create_user_id" property="createUserId"/>
        <result column="create_user_name" property="createUserName"/>
        <result column="create_time" property="createTime"/>
        <result column="org_name"  property="orgName"/>
        <result column="supplier_agreement_code"  property="supplierAgreementCode"/>
    </resultMap>
    <sql id="column">agreement_id,agreement_code,agreement_state,perform_start_date,perform_end_date,create_user_id,create_user_name,create_time
    </sql>
    <!-- 查询全部条目 -->
    <select id="selectAll" resultMap="agreementMap">
        select * from p_framework_agreement
    </select>
    <!-- 根据条件分页查询条目 -->
    <select id="selectByCondition" resultMap="agreementMap" parameterType="map">
        select *
        from(select s.*,ROW_NUMBER() OVER(order by s.create_time desc) r
        from (select
        DISTINCT
        pa.agreement_id,
        pa.agreement_code,
        pa.create_user_name,
        pa.create_time,
        so.org_name,
        pp.supplier_agreement_code,
        dic.dictionary_name as agreement_state,
        pa.perform_start_date,
        pa.perform_end_date
        from p_framework_agreement pa
        LEFT JOIN p_procurement_supplier pp
        ON pp.source_id = pa.agreement_id
        left join sys_org so
        on pp.supplier_org_id = so.org_id
        left join sys_dictionary dic
        on dic.dictionary_code = pa.agreement_state
        <where>
            1=1
            <if test="AgreementCondition!=null">
                <if test="AgreementCondition.createUserName!=null and AgreementCondition.createUserName!=''">
                    and pa.create_user_name = #{AgreementCondition.createUserName}
                </if>
                <if test="AgreementCondition.createStartTime!=null ">
                    and pa.create_time &gt;= #{AgreementCondition.createStartTime}
                </if>
                <if test="AgreementCondition.createEndTime!=null ">
                    and pa.create_time &lt;= #{AgreementCondition.createEndTime}
                </if>
                <if test="AgreementCondition.agreementCode!=null and AgreementCondition.agreementCode!=''">
                    and agreement_code like '%'|| #{AgreementCondition.agreementCode}|| '%'
                </if>
                <if test="AgreementCondition.agreementState!=null and AgreementCondition.agreementState!=''">
                    and agreement_state = #{AgreementCondition.agreementState}
                </if>
                <if test="AgreementCondition.performStartDate!=null ">
                    and perform_start_date &gt;= #{AgreementCondition.performStartDate}
                </if>
                <if test="AgreementCondition.performEndDate!=null ">
                    and perform_end_date &lt;= #{AgreementCondition.performEndDate}
                </if>
                <if test="AgreementCondition.orgName!=null and AgreementCondition.orgName!=''">
                    and so.org_name = #{AgreementCondition.orgName}
                </if>
                <if test="AgreementCondition.supplierAgreementCode!=null and AgreementCondition.supplierAgreementCode!=''">
                    and pp.supplier_agreement_code like '%'||{AgreementCondition.supplierAgreementCode} || '%'
                </if>
            </if>
        </where>
        ) s) d
         where d.r between #{page.startPos} and ((#{page.pageSize}+#{page.startPos})-1)
    </select>
    <!-- 插入一个实体 -->
    <insert id="insert" parameterType="Agreement" useGeneratedKeys="false">
        insert into  p_framework_agreement(
       agreement_id,agreement_code,agreement_state,perform_start_date,perform_end_date,create_user_id,create_user_name,create_time
        ) values(
        #{agreementId}, #{agreementCode}, #{agreementState},
        #{performStartDate}, #{performEndDate}, #{createUserId}, #{createUserName}, #{createTime}
        )

    </insert>
    <!-- 更新一个实体 -->
    <update id="update" parameterType="Agreement" >
        update  p_framework_agreement
        <set> perform_start_date = #{performStartDate},
              <if test="agreementState!=null and agreementState!=''">agreement_state = #{agreementState},</if>
              perform_end_date = #{performEndDate}
        </set>
        where agreement_id = #{agreementId}
    </update>
    <!-- 根据主键查询框架协议信息 -->
    <select id="selectByPk" resultMap="agreementMap" parameterType="string">
        select *
        FROM p_framework_agreement
        where
            agreement_id = #{agreementId}
    </select>

    <select id="countByCondition" resultType="int" parameterType="map">
    select count(*)
         FROM p_framework_agreement pa
        LEFT JOIN  p_procurement_supplier pp ON pa.agreement_id=pp.source_id
        left join sys_org so  on pp.supplier_org_id = so.org_id
         left join sys_dictionary dic
            on dic.dictionary_code = pa.agreement_state
        <where>
            1=1
            <if test="AgreementCondition!=null">
                <if test="AgreementCondition.createUserName!=null and AgreementCondition.createUserName!=''">
                    and pa.create_user_name = #{AgreementCondition.createUserName}
                </if>
                <if test="AgreementCondition.createStartTime!=null ">
                    and pa.create_time &gt;= #{AgreementCondition.createStartTime}
                </if>
                <if test="AgreementCondition.createEndTime!=null ">
                    and pa.create_time &lt;= #{AgreementCondition.createEndTime}
                </if>
                <if test="AgreementCondition.agreementCode!=null and AgreementCondition.agreementCode!=''">
                    and agreement_code  like  '%'|| #{AgreementCondition.agreementCode}|| '%'
                </if>
                <if test="AgreementCondition.agreementState!=null and AgreementCondition.agreementState!=''">
                    and agreement_state = #{AgreementCondition.agreementState}
                </if>
                <if test="AgreementCondition.performStartDate!=null ">
                    and perform_start_date  &gt;= #{AgreementCondition.performStartDate}
                </if>
                <if test="AgreementCondition.performEndDate!=null ">
                    and perform_end_date &lt;= #{AgreementCondition.performEndDate}
                </if>
                <if test="AgreementCondition.orgName!=null and AgreementCondition.orgName!=''">
                    and so.org_name = #{AgreementCondition.orgName}
                </if>
                <if test="AgreementCondition.supplierAgreementCode!=null and AgreementCondition.supplierAgreementCode!=''">
                    and pp.supplier_agreement_code like '%'||{AgreementCondition.supplierAgreementCode} || '%'
                </if>

            </if>
        </where>
    </select>

    <delete id="delete" parameterType="string">
        delete  from p_framework_agreement
        <where>
            agreement_id = #{agreementId}
        </where>
    </delete>
</mapper>