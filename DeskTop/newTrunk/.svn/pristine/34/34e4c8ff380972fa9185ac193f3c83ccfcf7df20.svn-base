<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ReceiptPackingDetail">
    <resultMap type="ReceiptPackingDetail" id="receiptPackingDetailMap">
        <id column="packing_detail_id" property="packingDetailId"/>
        <result column="packing_id" property="packingId"/>
        <result column="receipt_id" property="receiptId"/>
        <result column="receipt_code" property="receiptCode"/>
        <result column="packing_code" property="packingCode"/>
        <result column="delivery_count" property="deliveryCount"/>

        <result column="this_delivery_count" property="thisDeliveryCount"/>
        <result column="purchase_count" property="purchaseCount"/>
        <result column="dianshou_count" property="dianshouCount"/>
        <result column="storage_id" property="storageId"/>
        <result column="storage_code" property="storageCode"/>

        <result column="materials_id" property="materialsId"/>
        <result column="materials_code" property="materialsCode"/>
        <result column="wbs_id" property="wbsId"/>
        <result column="wbs_code" property="wbsCode"/>
        <result column="doc_source_detail_id" property="docSourceDetailId"/>

        <result column="doc_source_type" property="docSourceType"/>
        <result column="doc_source_no" property="docSourceNo"/>
        <result column="de_main_unit" property="deMainUnit"/>
        <result column="production_date" property="productionDate"/>
        <result column="bzq" property="bzq"/>

        <result column="materials_describe" property="materialsDescribe"/>
        <result column="additional_1" property="additional1"/>
        <result column="additional_2" property="additional2"/>
        <result column="additional_3" property="additional3"/>
        <result column="additional_4" property="additional4"/>
        <result column="device_no" property="deviceNo"/>

    </resultMap>
    <!-- 根据条件分页查询条目 -->
    <select id="selectByCondition" resultMap="receiptPackingDetailMap" parameterType="map">
        select * from(
        select
        de.packing_detail_id,de.wbs_id,de.wbs_code,de.materials_id,de.materials_code,de.materials_describe,
        de.additional_1,de.additional_2,de.additional_3,de.additional_4,de.purchase_count,de.dianshou_count,
        de.receipt_id,ru.receipt_code as receipt_code,pa.packing_no as packing_code,pa.packing_id as packing_id,
        de.de_main_unit,de.device_no,
        ROW_NUMBER() OVER(order by ru.receipt_id) r
        from
        ru_packing_detail de
        left join ru_goods_receipt ru
        on de.receipt_id=ru.receipt_id
        left join ru_packing pa
        on de.packing_id=pa.delivery_packing_id
        <where>
             de.RECEIPT_ID = pa.RECEIPT_ID and ru.receipt_state='receiptFinish'
            <if test="ReceiptGoodsCondition!=null">
                <if test="ReceiptGoodsCondition.receiptCode != null and ReceiptGoodsCondition.receiptCode != ''">
                    and ru.receipt_code = #{ReceiptGoodsCondition.receiptCode}
                </if>
                <if test="ReceiptGoodsCondition.supplierId != null and ReceiptGoodsCondition.supplierId != ''">
                    and ru.supplier_id = #{ReceiptGoodsCondition.supplierId}
                </if>
                <if test="ReceiptGoodsCondition.dataSource != null and ReceiptGoodsCondition.dataSource != ''">
                    and ru.in_storage = #{ReceiptGoodsCondition.dataSource}
                </if>
            </if>
        </where>
        )s
    </select>

    <!-- 根据条件查询条目数 -->
    <select id="countByCondition" resultType="int" parameterType="map">
        select count(*)
        from
        ru_packing_detail de
        left join ru_goods_receipt ru
        on de.receipt_id=ru.receipt_id
        left join ru_packing pa
        on de.packing_id=pa.delivery_packing_id
        <where>
            and de.RECEIPT_ID = pa.RECEIPT_ID and ru.receipt_state='receiptFinish'
            <if test="ReceiptGoodsCondition!=null">
                <if test="ReceiptGoodsCondition.receiptCode != null and ReceiptGoodsCondition.receiptCode != ''">
                    and ru.receipt_code = #{ReceiptGoodsCondition.receiptCode}
                </if>
                <if test="ReceiptGoodsCondition.supplierId != null and ReceiptGoodsCondition.supplierId != ''">
                    and ru.supplier_id = #{ReceiptGoodsCondition.supplierId}
                </if>
                <if test="ReceiptGoodsCondition.dataSource != null and ReceiptGoodsCondition.dataSource != ''">
                    and ru.in_storage = #{ReceiptGoodsCondition.dataSource}
                </if>
            </if>
        </where>
    </select>
    <insert id="insertList" parameterType="java.util.List" useGeneratedKeys="false">
        insert into ru_packing_detail
        (packing_detail_id,packing_id,
        receipt_id,packing_code,
        delivery_count,this_delivery_count,
        purchase_count,dianshou_count,
        storage_id,storage_code,
        materials_id,materials_code,
        wbs_id,wbs_code,
        doc_source_detail_id,doc_source_type,
        doc_source_no,de_main_unit,
        production_date,bzq,
        materials_describe,additional_1,
        additional_2,additional_3,
        additional_4,device_no
        )
        SELECT A.*
        FROM(
        <foreach collection="list" item="item" index="index" separator="UNION ALL">
            (SELECT
            #{item.packingDetailId} packing_detail_id,#{item.packingId} packing_id,
            #{item.receiptId} receipt_id,#{item.packingCode} packing_code,
            #{item.deliveryCount,jdbcType=DECIMAL} delivery_count,#{item.thisDeliveryCount,jdbcType=DECIMAL} this_delivery_count,
            #{item.purchaseCount,jdbcType=DECIMAL} purchase_count,#{item.dianshouCount,jdbcType=DECIMAL} dianshou_count,
            #{item.storageId} storage_id,#{item.storageCode} storage_code,
            #{item.materialsId} materials_id,#{item.materialsCode} materials_code,
            #{item.wbsId} wbs_id,#{item.wbsCode} wbs_code,
            #{item.docSourceDetailId} doc_source_detail_id,#{item.docSourceType} doc_source_type,
            #{item.docSourceNo} doc_source_no,#{item.deMainUnit} de_main_unit,
            #{item.productionDate,jdbcType=TIMESTAMP} production_date,#{item.bzq,jdbcType=TIMESTAMP} bzq,
            #{item.materialsDescribe} materials_describe,#{item.additional1} additional_1,
            #{item.additional2} additional_2,#{item.additional3} additional_3,
            #{item.additional4} additional_4,#{item.deviceNo} device_no
            FROM dual)
        </foreach>
        )A
    </insert>
    <select id="selectByReceiptId" resultMap="receiptPackingDetailMap">
        select * from ru_packing_detail where receipt_id=#{receiptId}
    </select>
    <delete id="delete" parameterType="string">
        delete from ru_packing_detail where receipt_id = #{receiptId}
    </delete>
</mapper>