<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="DeliveryPackageDetail">
    <resultMap id="deliveryPackageDetailMap" type="DeliveryPackageDetail">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Feb 27 10:19:13 CST 2017.
        -->
        <result column="packing_id" property="packingId" jdbcType="OTHER"/>
        <result column="packing_row_no" property="packingRowNo" jdbcType="DECIMAL"/>
        <result column="delivery_id" property="deliveryId" jdbcType="OTHER"/>
        <result column="delivery_no" property="deliveryNo" jdbcType="OTHER"/>
        <result column="wbs_id" property="wbsId" jdbcType="OTHER"/>
        <result column="wbs_code" property="wbsCode" jdbcType="OTHER"/>
        <result column="supplier_name" property="supplierName" jdbcType="OTHER"/>
        <result column="supplier_id" property="supplierId" jdbcType="OTHER"/>
        <result column="de_detail_id" property="deDetailId" jdbcType="OTHER"/>
        <result column="de_detail_rowno" property="deDetailRowno" jdbcType="DECIMAL"/>
        <result column="doc_source_detail_id" property="docSourceDetailId" jdbcType="OTHER"/>
        <result column="doc_source_type" property="docSourceType" jdbcType="OTHER"/>
        <result column="doc_source_no" property="docSourceNo" jdbcType="OTHER"/>
        <result column="materials_id" property="materialsId" jdbcType="OTHER"/>
        <result column="materials_code" property="materialsCode" jdbcType="OTHER"/>
        <result column="purchase_num" property="purchaseNum" jdbcType="DECIMAL"/>
        <result column="de_main_unit" property="deMainUnit" jdbcType="OTHER"/>
        <result column="de_sec_unit" property="deSecUnit" jdbcType="OTHER"/>
        <result column="delivery_main_count" property="deliveryMainCount" jdbcType="DECIMAL"/>
        <result column="delivery_sec_count" property="deliverySecCount" jdbcType="DECIMAL"/>
        <result column="conversion" property="conversion" jdbcType="DECIMAL"/>
        <result column="unit_price" property="unitPrice" jdbcType="DECIMAL"/>
        <result column="amount" property="amount" jdbcType="DECIMAL"/>
        <result column="currency_code" property="currencyCode" jdbcType="OTHER"/>
        <result column="production_date" property="productionDate" jdbcType="TIMESTAMP"/>
        <result column="bzq" property="bzq" jdbcType="TIMESTAMP"/>
        <result column="expiration_date" property="expirationDate" jdbcType="TIMESTAMP"/>
    </resultMap>
    <!--根据包装id查询其中的物料明细-->
    <select id="queryDetailByPackageId" resultMap="deliveryPackageDetailMap" parameterType="string">
        SELECT pdpd.*,pod.order_detail_count purchase_num from p_delivery_packing_detail pdpd
        left join p_order_detail pod on pdpd.doc_source_detail_id = pod.order_detail_id
        <where>
            pdpd.doc_source_type = 'purchase' and
            pdpd.packing_id = #{packageId}
        </where>
    </select>

    <delete id="delDeliveryPackageDetail" parameterType="string">
        delete from p_delivery_packing_detail pdpd
        <where>
            pdpd.delivery_id = #{deliveryId}
        </where>
    </delete>


    <select id="queryDetailByDeliveryId" parameterType="string" resultMap="deliveryPackageDetailMap">
        SELECT pdpd.*,pod.order_detail_count purchase_num from p_delivery_packing_detail pdpd
        left join p_order_detail pod on pdpd.doc_source_detail_id = pod.order_detail_id
        <where>
            pdpd.doc_source_type = 'purchase' and
            pdpd.delivery_id = #{deliveryId}
        </where>
    </select>
    <!-- 批量插入发货包装表 -->
    <insert id="insertList" parameterType="java.util.List" useGeneratedKeys="false">
        insert into p_delivery_packing_detail
        (packing_id, packing_row_no, delivery_id,delivery_no, wbs_id, wbs_code,supplier_name, supplier_id,
        de_detail_id,de_detail_rowno,
        doc_source_detail_id,doc_source_type, doc_source_no, materials_id,de_main_unit, de_sec_unit,
        delivery_main_count,
        delivery_sec_count, conversion, unit_price,amount, currency_code, production_date,bzq,
        expiration_date,materials_code)
        SELECT A.*
        FROM(
        <foreach collection="list" item="item" index="index" separator="UNION ALL">
            (SELECT
            #{item.packingId,jdbcType=VARCHAR} packing_id,
            #{item.packingRowNo,jdbcType=DECIMAL} packing_row_no,
            #{item.deliveryId,jdbcType=VARCHAR} delivery_id,
            #{item.deliveryNo,jdbcType=VARCHAR} delivery_no,
            #{item.wbsId,jdbcType=VARCHAR} wbs_id,
            #{item.wbsCode,jdbcType=VARCHAR} wbs_code,
            #{item.supplierName,jdbcType=VARCHAR} supplier_name,
            #{item.supplierId,jdbcType=VARCHAR} supplier_id,
            #{item.deDetailId,jdbcType=VARCHAR} de_detail_id,
            #{item.deDetailRowno,jdbcType=DECIMAL} de_detail_rowno,
            #{item.docSourceDetailId,jdbcType=VARCHAR} doc_source_detail_id,
            #{item.docSourceType,jdbcType=VARCHAR} doc_source_type,
            #{item.docSourceNo,jdbcType=VARCHAR} doc_source_no,
            #{item.materialsId,jdbcType=VARCHAR} materials_id,
            #{item.deMainUnit,jdbcType=VARCHAR} de_main_unit,
            #{item.deSecUnit,jdbcType=VARCHAR} de_sec_unit,
            #{item.deliveryMainCount,jdbcType=DECIMAL} delivery_main_count,
            #{item.deliverySecCount,jdbcType=DECIMAL} delivery_sec_count,
            #{item.conversion,jdbcType=DECIMAL} conversion,
            #{item.unitPrice,jdbcType=DECIMAL} unit_price,
            #{item.amount,jdbcType=DECIMAL} amount,
            #{item.currencyCode,jdbcType=VARCHAR} currency_code,
            #{item.productionDate,jdbcType=TIMESTAMP} production_date,
            #{item.bzq,jdbcType=TIMESTAMP} bzq,
            #{item.expirationDate,jdbcType=TIMESTAMP} expiration_date,
            #{item.materialsCode,jdbcType=VARCHAR} materials_code
            FROM dual)
        </foreach>
        )A
    </insert>

    <select id="selectByPk" parameterType="string" resultMap="deliveryPackageDetailMap">
      select * from p_delivery_packing_detail pdpd
        <where>
            pdpd.de_detail_id = #{deDetailId}
        </where>
    </select>
    
    <update id="update" >
        update p_delivery_packing_detail
        <set>
            <if test="receivedNum != null">received_num = #{receivedNum},</if>
            de_detail_id = #{deDetailId}
        </set>
        <where>
            de_detail_id = #{deDetailId}
        </where>
    </update>

</mapper>