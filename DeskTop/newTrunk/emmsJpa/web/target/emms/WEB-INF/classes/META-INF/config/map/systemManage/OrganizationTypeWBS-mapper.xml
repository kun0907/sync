<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

	<mapper namespace="OrganizationTypeWBS" >
		<resultMap type="OrganizationTypeWBS" id="organizationTypeWBSMap">
			<result column="org_id" property="orgId"/>
			<association property="organizationType" resultMap="OrganizationType.organizationTypeMap"></association>
		    <association property="project" column="project" resultMap="Project.projectMap"></association>
		</resultMap>
		<resultMap type="OrganizationTypeWBS" id="organizationTypeWBS2Map">
			<result column="org_id" property="orgId"/>
			<association property="project" column="project" javaType="Project">
				<id column="project_id" property="projectId"/>
				<result column="project_code" property="projectCode"/>
				<result column="project_name" property="projectName"/>
			</association>
		</resultMap>
		<!-- 批量插入机构类型WBS表 -->
		<insert id="insertList" parameterType="java.util.List" useGeneratedKeys="false">
			insert into sys_org_type_wbs
			(org_type_id,org_id,wbs_id)
			SELECT A.*
			FROM(
			<foreach collection="list" item="item" index="index" separator="UNION ALL">
				(SELECT 
				#{item.organizationType.orgTypeId,jdbcType=VARCHAR} org_type_id,
				#{item.orgId,jdbcType=VARCHAR} org_id,
				#{item.project.projectId,jdbcType=VARCHAR} wbs_id
				FROM dual)
			</foreach>
			)A 
		</insert>
  		<!-- 根据组织机构id删除机构类型wbs表 -->
  		<delete id="deleteOrgTypeWBSByOrg" parameterType="string">
  			delete from sys_org_type_wbs sotw
  			<where>
  				sotw.org_id = #{orgId}
  			</where>
  		</delete>
  		
  		<!-- 根据组织机构id和组织机构类型查询wbs -->
  		<select id="selectOrgTypeWBSByType" parameterType="OrganizationTypeWBS" resultType="java.util.HashMap">
  			select sotw.org_type_id,sotw.org_id,sotw.wbs_id,bp.project_id,bp.project_code from sys_org_type_wbs sotw
  			left join b_project bp on sotw.wbs_id = bp.project_id
  			left join sys_org_type sot on sotw.org_type_id = sot.org_type_id 
  			<where>
				1=1
				<if test="orgId!= null and orgId!=''">and sotw.org_id = #{orgId}</if>
				<if test="orgTypeId!= null and orgTypeId!=''">and sotw.org_type_id = #{orgTypeId}</if>
  			</where>
  		</select>
		<!--根据组织结构id查询wbs列表 -->
		<select id="selectOrgTypeWBSByOrg" parameterType="map" resultType="java.util.HashMap">
			select sotw.*,bp.project_id,bp.project_code,bp.project_name from sys_org_type_wbs sotw
			left join b_project bp on sotw.wbs_id = bp.project_id
			left join sys_org_type sot on sotw.org_type_id = sot.org_type_id
			<where>
				sotw.org_id = #{orgId} and sot.org_type = #{orgTypeCode}
			</where>
		</select>
		<!--根据组织机构id查询wbs-->
		<select id="selectOrgTypeWBSByOrgId" parameterType="map" resultMap="organizationTypeWBSMap">
			select sotw.*,bp.project_id,bp.project_code,bp.project_name from sys_org_type_wbs sotw
			left join b_project bp on sotw.wbs_id = bp.project_id
			left join sys_org_type sot on sotw.org_type_id = sot.org_type_id
			<where>
				sotw.org_id = #{orgId}
			</where>
		</select>
	</mapper>
