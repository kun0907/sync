<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Project">
	<resultMap type="Project" id="projectMap">
		<id column="project_id" property="projectId"/>
		<result column="parent_id" property="parentId"/>
		<result column="project_level" property="level"/>
		<result column="project_code" property="projectCode"/>
		<result column="project_name" property="projectName"/>
		<result column="project_state" property="projectState"/>
		<result column="org_name" property="orgName"/>
		<result column="org_type" property="orgType"/>
		<result column="is_main" property="isMain"/>
		<result column="is_complish" property="isComplish"/>
		<result column="project_type" property="projectType"/>
		<result column="project_id_seq" property="projectIdSeq"/>
		<result column="project_code_seq" property="projectCodeSeq"/>
		<result column="create_user_name" property="createUserName"/>
		<result column="create_user_id" property="createUserId"/>
		<result column="create_time" property="createTime"/>
		<result column="submit_user_name" property="submitUserName"/>
		<result column="submit_user_id" property="submitUserId"/>
		<result column="submit_time" property="submitTime"/>
	</resultMap>
	<sql id="all">project_id,parent_id,project_level,project_code,project_name,project_state,
	    is_main,is_finish,create_user_name,create_user_id,create_time,project_id_seq,project_code_seq,
	    submit_user_name,submit_user_id,submit_time,project_type</sql>
	<!-- 查询全部节点  tree用  -->
	<select id="selectAll" resultMap="projectMap">
		select * from B_PROJECT
	</select>
	<!-- 分页查询项目信息  -->
	<select id="selectByCondition" resultType="java.util.HashMap" parameterType="map">
		select * from (
			select dic.is_del,bp.project_id,bp.parent_id,bp.project_level,bp.project_code,bp.project_name,dic.dictionary_name as project_state,
	        bp.is_main,bp.is_finish,bp.create_user_name,bp.create_user_id,bp.create_time,bp.project_id_seq,bp.project_code_seq,
	        bp.submit_user_name,bp.submit_user_id,bp.submit_time,bpp.project_name as parentName, ROW_NUMBER() OVER(order by bp.create_time desc) r 
			from B_PROJECT bp
			left join sys_dictionary dic
			on dic.dictionary_code = bp.project_state
			left join B_PROJECT bpp
			on bpp.project_id = bp.parent_id
			<where>
				is_del='1'
				<if test="ProjectCondition.projectCode!=null and ProjectCondition.projectCode!=''">and bp.project_code  = #{ProjectCondition.projectCode} </if>		
				<if test="ProjectCondition.projectName!=null and ProjectCondition.projectName!=''">and bp.project_name like '%' || #{ProjectCondition.projectName} || '%'</if>		
				<!--<if test="ProjectCondition.isMain!=null and ProjectCondition.isMain!=''">and bp.is_main = #{ProjectCondition.isMain}</if>-->
				<if test="ProjectCondition.parentId!=null and ProjectCondition.parentId!=''">and bp.parent_id = #{ProjectCondition.parentId}</if>				
			    <if test="ProjectCondition.projectState!=null and ProjectCondition.projectState!=''">and bp.project_state = #{ProjectCondition.projectState}</if>				
			</where>
		) s where 1=1  <if test="ProjectCondition.isMain=='1'">and s.r between #{page.startPos} and ((#{page.pageSize}+#{page.startPos})-1) </if>
		
	</select>
	<!-- 分页查询项目数量 -->
	<select id="countByCondition" resultType="int" parameterType="map">
		select count(*) from B_PROJECT bp
		left join sys_dictionary dic
		on dic.dictionary_code = bp.project_state
		left join B_PROJECT bpp
		on bpp.project_id = bp.parent_id
		<where>
			dic.is_del='1'
			<if test="ProjectCondition.projectCode!=null and ProjectCondition.projectCode!=''">and bp.project_code = #{ProjectCondition.projectCode} </if>		
			<if test="ProjectCondition.projectName!=null and ProjectCondition.projectName!=''">and bp.project_name like '%' || #{ProjectCondition.projectName} || '%'</if>		
			<!--<if test="ProjectCondition.isMain!=null and ProjectCondition.isMain!=''">and bp.is_main = #{ProjectCondition.isMain}</if>-->
		    <if test="ProjectCondition.parentId!=null and ProjectCondition.parentId!=''">and bp.parent_id = #{ProjectCondition.parentId}</if>
		    <if test="ProjectCondition.projectState!=null and ProjectCondition.projectState!=''">and bp.project_state = #{ProjectCondition.projectState}</if>				
		</where>
	</select>
	<!-- 根据主键查询项目信息 -->
	<select id="selectByPk" resultMap="projectMap" parameterType="string">
		select <include refid="all" /> from B_PROJECT bp
		<where>
			project_id = #{projectId}
		</where>
	</select>
	
	<!-- 根据项目Code获取个数 -->
	<select id="countByProjectCode" resultType="int" parameterType="string" >
		select count(*) from B_PROJECT bp 
		<where>
			project_code = #{projectCode}
		</where>
	</select>
	
	<!-- 插入项目信息 -->
	<insert id="insert" useGeneratedKeys="false">
		insert into B_PROJECT (
			project_id,parent_id,project_level,project_code,project_type,project_name,project_state,is_main,is_finish,create_user_name,
			create_user_id,create_time,project_id_seq,project_code_seq,submit_user_name,submit_user_id,submit_time
		) values (
			#{projectId},#{parentId},#{level},#{projectCode},#{projectType},#{projectName},#{projectState},#{isMain},#{isFinish},
			#{createUserName},#{createUserId},#{createTime},#{projectIdSeq},#{projectCodeSeq},#{submitUserName},#{submitUserId},#{submitTime}
		)
	</insert>
	
	<!-- 更新项目信息 -->
	<update id="update">
		update B_PROJECT 
		<set>   
			<if test="level!= null and level!=''">project_level = #{level},</if>
			<if test="projectName!= null and projectName!=''">project_name = #{projectName},</if>
			<if test="projectState!= null and projectState!=''">project_state = #{projectState},</if>
			<if test="isFinish!= null and isFinish!=''">is_finish = #{isFinish},</if>
			<if test="projectType!= null and projectType!=''">project_type = #{projectType},</if>
			project_id = #{projectId}
		</set>
		where project_id = #{projectId}
	</update>
	<!-- 根据id查询子项目是否全部完结-->
	<select id="selectProjectByParent" resultType="int" parameterType="string" >
		select count(*) from B_PROJECT 
		<where>
			project_code_seq like #{id} || '%'
		</where>
	</select>
	<!-- 根据id查询子项目-->
	<select id="selectProjectByParentId" resultMap="projectMap" parameterType="string" >
		select project_id,project_code,project_name from B_PROJECT
		<where>
			parent_id=#{parentId} and is_finish='0' and project_state ='wbspass'
		</where>
	</select>
	<!-- 根据code-->
	<select id="selectProjectByCode" resultMap="projectMap" parameterType="string" >
		select * from B_PROJECT
		<where>
			project_code=#{code} and is_main='0'
		</where>
	</select>
	<!-- 根据codeseq-->
	<select id="selectProjectByCodeSeq" resultMap="projectMap" parameterType="string" >
		select * from B_PROJECT
		<where>
			project_code_seq=#{code} and is_main='0'
		</where>
	</select>

	<!-- 根据主键查询项目信息 供应商 -->
	<select id="selectProjectOrgById" resultMap="projectMap" parameterType="string">
		select wm_concat(to_char(so.ORG_NAME))  as ORG_NAME,sot.org_type,bp.project_type,
		bp.PROJECT_ID,bp.PROJECT_CODE,bp.PROJECT_NAME from B_PROJECT bp
		left join sys_org_type_wbs sotw on sotw.WBS_ID = bp.PROJECT_ID
		left join sys_org_type sot on sotw.ORG_TYPE_ID = sot.ORG_TYPE_ID
		left join sys_org so on  so.ORG_ID = sotw.ORG_ID
		<where>
			project_id = #{projectId}
		</where>
			group by  bp.PROJECT_ID,bp.PROJECT_CODE,bp.PROJECT_NAME,bp.project_type,sot.org_type
	</select>

</mapper>

