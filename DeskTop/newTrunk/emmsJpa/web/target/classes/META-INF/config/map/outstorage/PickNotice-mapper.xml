<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="PickNotice">
    <resultMap id="PickNoticeMap" type="PickNotice">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Mon Mar 20 19:37:12 CST 2017.
        -->
        <id column="pick_id" property="pickId" jdbcType="VARCHAR"/>
        <result column="pick_no" property="pickNo" jdbcType="VARCHAR"/>
        <result column="pick_time" property="pickTime" jdbcType="TIMESTAMP"/>
        <result column="create_user_id" property="createUserId" jdbcType="VARCHAR"/>
        <result column="create_user_name" property="createUserName" jdbcType="VARCHAR"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="pick_notice_state" property="pickNoticeState" jdbcType="VARCHAR"/>
        <association property="supplier" column="supplier" select="Organization.selectByPk"/>
        <collection property="pickNoticeDetailList" column="pick_id" select="PickNoticeDetail.queryDetailByPickNotice"/>
    </resultMap>

    <!-- 分页领料通知数量 -->
    <select id="countByCondition" resultType="int" parameterType="map">
        select count(*) from out_pick_notice opn
        left join sys_org so on so.org_id = opn.supplier
        <where>
            <if test="PickNoticeCondition.pickNoticeNo!=null and PickNoticeCondition.pickNoticeNo!=''">and opn.pick_no
                like '%'|| #{PickNoticeCondition.pickNoticeNo} || '%'
            </if>
            <if test="PickNoticeCondition.supplierId!=null and PickNoticeCondition.supplierId!=''">
                and opn.supplier = #{PickNoticeCondition.supplierId}
            </if>
            <if test="PickNoticeCondition.pickNoticeState!=null and PickNoticeCondition.pickNoticeState!=''">and
                opn.pick_notice_state = #{PickNoticeCondition.pickNoticeState}
            </if>
            <if test="PickNoticeCondition.createUserName!=null and PickNoticeCondition.createUserName!=''">and
                opn.create_user_name like '%'|| #{PickNoticeCondition.createUserName} || '%'
            </if>
            <if test="PickNoticeCondition.beginTime!=null">and
                <![CDATA[ opn.create_time  >=  #{PickNoticeCondition.beginTime} ]]> </if>
            <if test="PickNoticeCondition.endTime!=null">and
                <![CDATA[ opn.create_time  <= #{PickNoticeCondition.endTime} ]]> </if>
        </where>
    </select>

    <!-- 分页领料通知信息  -->
    <select id="selectByCondition" resultMap="PickNoticeMap" parameterType="map">
        select * from (
        select opn.pick_id,opn.pick_no,opn.pick_time,opn.create_user_name,opn.create_time,opn.supplier,opn.pick_notice_state,ROW_NUMBER() OVER(order by opn.create_time desc) r
        from out_pick_notice opn
        left join sys_org so on so.org_id = opn.supplier
        <where>
            <if test="PickNoticeCondition.pickNoticeNo!=null and PickNoticeCondition.pickNoticeNo!=''">and opn.pick_no
                like '%'|| #{PickNoticeCondition.pickNoticeNo} || '%'
            </if>
            <if test="PickNoticeCondition.supplierId!=null and PickNoticeCondition.supplierId!=''">and opn.supplier = #{PickNoticeCondition.supplierId}</if>
            <if test="PickNoticeCondition.pickNoticeState!=null and PickNoticeCondition.pickNoticeState!=''">and
                opn.pick_notice_state = #{PickNoticeCondition.pickNoticeState}
            </if>
            <if test="PickNoticeCondition.createUserName!=null and PickNoticeCondition.createUserName!=''">and
                opn.create_user_name like '%'|| #{PickNoticeCondition.createUserName} || '%'
            </if>
            <if test="PickNoticeCondition.beginTime!=null">and
                <![CDATA[ opn.create_time  >=  #{PickNoticeCondition.beginTime} ]]> </if>
            <if test="PickNoticeCondition.endTime!=null">and
                <![CDATA[ opn.create_time  <= #{PickNoticeCondition.endTime} ]]> </if>
        </where>
        ) s where s.r between #{page.startPos} and ((#{page.pageSize}+#{page.startPos})-1)
    </select>
    
    <select id="selectByPk" resultMap="PickNoticeMap" parameterType="string">
      select * from out_pick_notice opn
      <where>
          opn.pick_id = #{pickId}
      </where>
    </select>

    <!--插入领料通知信息-->
    <insert id="insert" useGeneratedKeys="false">
        insert into out_pick_notice (pick_id, pick_no, pick_time,supplier, create_user_id, create_user_name,create_time,pick_notice_state)
        values (#{pickId,jdbcType=VARCHAR}, #{pickNo,jdbcType=VARCHAR}, #{pickTime,jdbcType=TIMESTAMP},
        #{supplier.orgId,jdbcType=VARCHAR}, #{createUserId,jdbcType=VARCHAR}, #{createUserName,jdbcType=VARCHAR},
        #{createTime,jdbcType=TIMESTAMP},#{pickNoticeState,jdbcType=TIMESTAMP})
    </insert>
    <!--更新领料通知信息-->
    <update id="update">
        update out_pick_notice
        <set>
            <if test="pickTime!= null">pick_time = #{pickTime},</if>
            <if test="supplier!= null">supplier = #{supplier.orgId},</if>
            <if test="pickNoticeState!= null and pickNoticeState!=''">pick_notice_state = #{pickNoticeState},</if>
            pick_id = #{pickId}
        </set>
        <where>
            pick_id = #{pickId}
        </where>
    </update>
    
    <delete id="deletePickNotice" parameterType="PickNotice">
        delete from out_pick_notice opn
        <where>
            opn.pick_id = #{pickId}
        </where>
    </delete>
    
    <select id="selectAbateList" resultMap="PickNoticeMap" parameterType="int">
        select * from OUT_PICK_NOTICE
        <where>
            (TRUNC(pick_time) - TRUNC(SYSDATE)) >= #{days}
        </where>
    </select>
</mapper>