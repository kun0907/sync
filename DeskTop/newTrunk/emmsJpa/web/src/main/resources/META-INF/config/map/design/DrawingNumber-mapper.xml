<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="DrawingNumber">

    <resultMap type="DrawingNumber" id="DrawingNumberMap">
		<id column="drawing_number_id" property="drawingNumberId"/>
		<result column="drawing_number_code" property="drawingNumberCode"/>
		<result column="drawing_number_version" property="drawingNumberVersion"/>
		<result column="project_id" property="projectId"/>
		<result column="project_code_seq" property="projectCodeSeq"/>
		<result column="materials_table_id" property="materialsTableId"/>
		<result column="materials_table_code" property="materialsTableCode"/>
		<result column="design_org_id" property="designOrgId"/>
		<result column="design_org_name" property="designOrgName"/>
		
		<result column="drawing_number_device_no" property="designOrgCode"/>
		<result column="drawing_number_state" property="drawingNumberState"/>
		<result column="drawing_number_type" property="drawingNumberType"/>
		<result column="confirm_user_id" property="confirmUserId"/>
		<result column="confirm_user_name" property="confirmUserName"/>
		<result column="confirm_time" property="confirmTime"/>
	</resultMap>
	
	<sql id="column">drawing_number_id,drawing_number_code,drawing_number_version,project_id,
                     project_code_seq,materials_table_id,materials_table_code,design_org_id,design_org_name,
                     drawing_number_device_no,drawing_number_state,drawing_number_type,confirm_user_id,confirm_user_name,confirm_time
    </sql> 
    
     <!-- 根据条件分页查询条目 -->
	<select id="selectByCondition" resultMap="DrawingNumberMap" parameterType="map">
		select * from(
			select dn.drawing_number_id,dn.drawing_number_code,dn.drawing_number_version,dn.project_id,
                   dn.project_code_seq,dn.materials_table_id,dn.materials_table_code,dn.design_org_id,dn.design_org_name,
                   dn.drawing_number_device_no,dicc.dictionary_name as drawing_number_state,dic.dictionary_name as drawing_number_type,confirm_user_id,confirm_user_name,confirm_time,
			ROW_NUMBER() OVER(order by dn.confirm_time) r
			from d_drawing_number dn
			left join D_DRAWING_DETAILED dd on dn.drawing_number_id = dd.drawing_number_id
			left join d_materials_table mt on dd.materials_table_id = mt.materials_table_id
			left join sys_dictionary dic
			on dic.dictionary_code = dn.drawing_number_type
			left join sys_dictionary dicc
			on dicc.dictionary_code = dn.drawing_number_state
			<where>
				mt.materials_table_state='drawingNumber'
				<if test="DrawingNumberCondition.drawingNumberCode!=null and DrawingNumberCondition.drawingNumberCode!=''">
					and dn.drawing_number_code = #{DrawingNumberCondition.drawingNumberCode}
				</if>
				<if test="DrawingNumberCondition.designOrgId!=null and DrawingNumberCondition.designOrgId!=''">
					and dn.design_org_id = #{DrawingNumberCondition.designOrgId}
				</if>
				<if test="DrawingNumberCondition.designOrgs!=null and DrawingNumberCondition.designOrgs.size>0">
					and dn.design_org_id in
					<foreach collection="DrawingNumberCondition.designOrgs" index="index" item="designOrg" open="(" separator="," close=")">
						#{designOrg.orgId}
					</foreach>
				</if>
				<if test="DrawingNumberCondition.drawingNumberType!=null and DrawingNumberCondition.drawingNumberType!=''">
					and dn.drawing_number_type = #{DrawingNumberCondition.drawingNumberType}
				</if>
				<if test="DrawingNumberCondition.projectId!=null and DrawingNumberCondition.projectId!=''">
					and dn.project_id = #{DrawingNumberCondition.projectId}
				</if>
				<if test="DrawingNumberCondition.drawingNumberState!=null and DrawingNumberCondition.drawingNumberState!=''">
					and dn.drawing_number_state = #{DrawingNumberCondition.drawingNumberState}
				</if>
			</where>
		) s
		where s.r between #{page.startPos} and ((#{page.pageSize}+#{page.startPos})-1)
	</select>
	
	<!-- 根据条件查询条目数 -->
	<select id="countByCondition" resultType="int" parameterType="map">
		select count(*) from d_drawing_number dn
		left join D_DRAWING_DETAILED dd on dn.drawing_number_id = dd.drawing_number_id
		left join d_materials_table mt on dd.materials_table_id = mt.materials_table_id
		<where>
				mt.materials_table_state='drawingNumber'
				<if test="DrawingNumberCondition.drawingNumberCode!=null and DrawingNumberCondition.drawingNumberCode!=''">
					and dn.drawing_number_code = #{DrawingNumberCondition.drawingNumberCode}
				</if>
				<if test="DrawingNumberCondition.designOrgId!=null and DrawingNumberCondition.designOrgId!=''">
					and dn.design_org_id = #{DrawingNumberCondition.designOrgId}
				</if>
				<if test="DrawingNumberCondition.designOrgs!=null and DrawingNumberCondition.designOrgs.size>0">
					and dn.design_org_id in
					<foreach collection="DrawingNumberCondition.designOrgs" index="index" item="designOrg" open="(" separator="," close=")">
						#{designOrg.orgId}
					</foreach>
				</if>
				<if test="DrawingNumberCondition.drawingNumberType!=null and DrawingNumberCondition.drawingNumberType!=''">
					and dn.drawing_number_type = #{DrawingNumberCondition.drawingNumberType}
				</if>
				<if test="DrawingNumberCondition.projectId!=null and DrawingNumberCondition.projectId!=''">
					and dn.project_id = #{DrawingNumberCondition.projectId}
				</if>
				<if test="DrawingNumberCondition.drawingNumberState!=null and DrawingNumberCondition.drawingNumberState!=''">
					and dn.drawing_number_state = #{DrawingNumberCondition.drawingNumberState}
				</if>
			</where>
	</select>  
	
	<!-- 根据ID查询单个实体 -->
	<select id="selectByPk" resultMap="DrawingNumberMap" parameterType="string">
		select <include refid="column" /> from d_drawing_number dn where  dn.drawing_number_id = #{drawingNumberId}
	</select>
	
	<!-- 插入一个实体 -->
	<insert id="insert" parameterType="DrawingNumber" useGeneratedKeys="false">
		insert into d_drawing_number(
			drawing_number_id,drawing_number_code,drawing_number_version,project_id,
            project_code_seq,materials_table_id,materials_table_code,design_org_id,design_org_name,
            drawing_number_device_no,drawing_number_state,drawing_number_type,confirm_user_id,confirm_user_name,confirm_time
		) values(
			#{drawingNumberId}, #{drawingNumberCode}, #{drawingNumberVersion}, #{projectId},
			#{projectCodeSeq},  #{materialsTableId},#{materialsTableCode}, #{designOrgId},#{designOrgName},
			#{drawingNumberDeviceNo},  #{drawingNumberState},#{drawingNumberType}, #{confirmUserId},#{confirmUserName},#{confirmTime}
		)
	</insert>
	
	<!-- 批量插入 -->
	<insert id="insertList" parameterType="java.util.List" useGeneratedKeys="false">
		insert into d_drawing_number(
			drawing_number_id,drawing_number_code,drawing_number_version,project_id,
            project_code_seq,materials_table_id,materials_table_code,design_org_id,design_org_name,
            drawing_number_device_no,drawing_number_state,drawing_number_type,confirm_user_id,confirm_user_name,confirm_time
		)
		SELECT A.*
		FROM(
		<foreach collection="list" item="item" index="index" separator="UNION ALL">
			(SELECT 
				#{item.drawingNumberId}, #{item.drawingNumberCode}, #{item.drawingNumberVersion}, #{item.projectId},
				#{item.projectCodeSeq},  #{item.materialsTableId},#{item.materialsTableCode}, #{item.designOrgId},#{item.designOrgName},
				#{item.drawingNumberDeviceNo},  #{item.drawingNumberState},#{item.drawingNumberType}, #{item.confirmUserId},#{item.confirmUserName},#{item.confirmTime}
			FROM dual)
		</foreach>
		)A 
	</insert>
	
	<!-- 根据code查询条目数 -->
	<select id="countByCode" resultType="int" parameterType="String">
		select count(*)
		from d_drawing_number
		where 
		drawing_number_code = #{drawingNumberCode}
	</select>

	<!-- 根据料表ID查询图号列表 -->
	<select id="selectByMTid" resultMap="DrawingNumberMap" parameterType="String">
		select *
		from d_drawing_number
		where
		materials_table_id = #{materialsTableId}
	</select>
	
	<!-- 根据code更新 -->
	<update id="updateByCode" parameterType="DrawingNumber">
		update d_drawing_number
		<set>
			<if test="drawingNumberState!=null and drawingNumberState!=''">drawing_number_state = #{drawingNumberState}</if>
			<if test="confirmUserId!=null and confirmUserId!=''">confirm_user_id = #{confirmUserId}</if>
			<if test="confirmUserName!=null and confirmUserName!=''">confirm_user_name = #{confirmUserName}</if>
			<if test="confirmTime!=null and confirmTime!=''">confirm_time = #{confirmTime}</if>
		</set>
		where drawing_number_id = #{drawingNumberId}
	</update>
	
	<!-- 根据code查询 -->
	<select id="selectByCode" resultMap="DrawingNumberMap" parameterType="string">
		select <include refid="column" /> from d_drawing_number dn where dn.drawing_number_code = #{drawingNumberCode}
	</select>

	<!-- 根据料表id删除图号 -->
	<delete id="deleteByMTid" parameterType="string">
		delete from d_drawing_number where materials_table_id = #{materialsTableId}
	</delete>
	
</mapper>